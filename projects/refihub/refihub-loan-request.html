<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RefiHub Loan Request Game</title>
    <script src="js/refihub-nav.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/games/refihub-loan-request.css">
</head>
<body>
    <refihub-nav></refihub-nav>
    <div id="game-container">
        <!-- Browser Window (Now First) -->
        <div id="browser-window">
            <div class="browser-header">
                 <!-- Mock Window Controls -->
                 <div class="window-controls">
                    <div class="window-dot dot-red"></div>
                    <div class="window-dot dot-yellow"></div>
                    <div class="window-dot dot-green"></div>
                 </div>
                <div class="browser-tabs">
                    <div class="browser-tab active">RefiHub</div>
                </div>
                <div class="browser-address">refihub.com/refinance-simulator</div>
            </div>
            <div class="browser-content">
                 <!-- Initial State: Instructions & Drop Zone -->
                 <div id="instructions-panel">
                     <h3>Welcome to the RefiHub Simulator!</h3>
                     <p style="text-align: center; margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.95rem;">
                         Refinancing made easy. Drag your existing loan document below, and our AI will analyze it to find better terms from leading lenders.
                     </p>
                     <h4 style="text-align: center; margin-bottom: 0.5rem; font-weight: 600;">How it Works (3 Steps):</h4>
                     <ol>
                         <li><strong>Upload & Confirm:</strong> Drag your loan PDF from the File Browser below to the zone here. Review and confirm the extracted details of your current loan.</li>
                         <li><strong>Set Goal:</strong> Choose what you want to achieve (e.g., lower rate, cash out).</li>
                         <li><strong>Review Offers:</strong> See simulated lender offers and how much you can save or gain!</li>
                     </ol>
                 </div>
                 <div class="drop-zone" id="drop-zone">
                     <div class="drop-zone-icon">ðŸ“„</div> <!-- Updated Icon -->
                     <div class="drop-zone-text">Drag and drop your loan document here</div>
                 </div>
 
                 <!-- Inline Processing Indicator -->
                  <div id="inline-spinner">Processing Loan Document...</div>
 
                  <!-- Container for Inline Loan Info Display -->
                  <div id="current-loan-info-container">
                      <!-- Property Details -->
                      <div class="info-section">
                          <h3>Property Details</h3>
                          <div class="info-grid">
                              <div class="info-item">
                                  <div class="info-label">Property Type</div>
                                  <div class="info-value">- - -</div>
                              </div>
                              <div class="info-item">
                                  <div class="info-label">Location</div>
                                  <div class="info-value">- - -</div>
                              </div>
                              <div class="info-item">
                                  <div class="info-label">Square Footage / Units</div>
                                  <div class="info-value">- - -</div>
                              </div>
                          </div>
                      </div>
                      <!-- Current Loan Details -->
                      <div class="info-section">
                          <h3>Current Loan Details</h3>
                          <div class="info-grid">
                              <div class="info-item">
                                  <div class="info-label">Current Balance</div>
                                  <div class="info-value">- - -</div>
                              </div>
                              <div class="info-item">
                                  <div class="info-label">Loan Type</div>
                                  <div class="info-value">- - -</div>
                              </div>
                              <div class="info-item">
                                  <div class="info-label">Remaining Term</div>
                                  <div class="info-value">- - -</div>
                              </div>
                              <div class="info-item">
                                  <div class="info-label">Current Interest Rate</div>
                                  <div class="info-value">- - -</div>
                              </div>
                              <div class="info-item">
                                  <div class="info-label">Current Monthly P&I</div>
                                  <div class="info-value">- - -</div>
                              </div>
                          </div>
                      </div>
                      <!-- Borrower Info -->
                      <div class="info-section">
                          <h3>Borrower Information</h3>
                          <div class="info-grid">
                              <div class="info-item">
                                  <div class="info-label">Name</div>
                                  <div class="info-value">- - -</div>
                              </div>
                              <div class="info-item">
                                  <div class="info-label">Type</div>
                                  <div class="info-value">- - -</div>
                              </div>
                              <div class="info-item">
                                  <div class="info-label">Experience</div>
                                  <div class="info-value">- - -</div>
                              </div>
                          </div>
                      </div>
                      <!-- Guarantor Info -->
                      <div class="info-section">
                          <h3>Guarantor Information</h3>
                          <div class="info-grid">
                              <div class="info-item">
                                  <div class="info-label">Name</div>
                                  <div class="info-value">- - -</div>
                              </div>
                              <div class="info-item">
                                  <div class="info-label">Net Worth</div>
                                  <div class="info-value">- - -</div>
                              </div>
                              <div class="info-item">
                                  <div class="info-label">Credit Score</div>
                                  <div class="info-value">- - -</div>
                              </div>
                          </div>
                      </div>
                      <!-- Confirm Button (Moved Here) -->
                      <div class="game-controls">
                          <button class="btn btn-primary" id="confirm-goal-btn" disabled>Confirm Details & Set Goal</button>
                      </div>
                  </div> <!-- End #current-loan-info-container -->
            </div> <!-- End .browser-content -->
        </div> <!-- End #browser-window -->

        <!-- File Browser (Previously Desktop, Now Second) -->
        <div id="file-browser">
            <div class="file-browser-header">
                <!-- Mock Window Controls -->
                 <div class="window-controls">
                    <div class="window-dot dot-red"></div>
                    <div class="window-dot dot-yellow"></div>
                    <div class="window-dot dot-green"></div>
                 </div>
                <div class="file-browser-title">Your Existing Loans</div>
            </div>
            <div class="file-item-list">
                <!-- Files will be populated dynamically -->
            </div>
        </div>

    </div> <!-- End #game-container -->

    <!-- Step 2: Goal Selection View (Overlay) -->
    <div id="goal-view" class="view">
        <h3>Set Your Refinancing Goal</h3>
        <div class="goal-options">
            <label class="goal-option" for="goal-all">
                <input type="radio" id="goal-all" name="refi-goal" value="all" checked>
                <span class="goal-title">All Offers</span>
                <span class="goal-description">See all available refinancing options from our lender network.</span>
            </label>
            <label class="goal-option" for="goal-rate">
                <input type="radio" id="goal-rate" name="refi-goal" value="rate">
                <span class="goal-title">Lowest Rate</span>
                <span class="goal-description">Prioritize offers with the lowest possible interest rate.</span>
            </label>
            <label class="goal-option" for="goal-cashout">
                <input type="radio" id="goal-cashout" name="refi-goal" value="cashout">
                <span class="goal-title">Maximize Cash Out</span>
                <span class="goal-description">Prioritize offers that allow you to borrow more against your equity.</span>
            </label>
        </div>
        <div class="game-controls" style="margin-top: 2rem;">
             <button class="btn btn-primary" id="find-offers-btn">Find Lender Offers</button>
             <!-- Maybe add a back button here later if needed -->
        </div>
    </div>

    <!-- Step 3: Offers View (Overlay) -->
    <div id="offers-view" class="view">
        <h3>Available Refinance Offers</h3>
        <div id="offers-container">
            <!-- Offer cards will be dynamically added here -->
        </div>
        <!-- Add the notification element here -->
        <div id="offer-selection-notification"></div>
        <div class="game-controls">
             <button class="btn btn-secondary" onclick="handleCancelOffers()">Cancel</button>
             <button class="btn btn-primary" onclick="handleProcessAnotherLoan()">Process Another Loan</button>
        </div>
    </div>

     <!-- Removed the old view divs -->
 
     <script>
        // ==========================================
        //          GAME STATE & CONFIG
        // ==========================================
        let gameState = {
            currentStep: 0, // 0: Intro/Upload, 1: Confirmed, 2: Set Goal, 3: Review Offers
            selectedFile: null,
            confirmedLoanData: null,
            selectedGoal: null,
            lastGeneratedOffers: [], // Store the last generated offers
            stats: {
                loansRefinanced: 0,
                totalRateSaved: 0,
                totalPaymentReduced: 0,
                totalCashOut: 0,
                avgRateSaved: 0 // For displaying average
            }
        };

        // Formatting Helpers
        const currencyFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        const percentFormatter = new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // ==========================================
        //          DOM REFERENCES
        // ==========================================
        // Assume all these elements exist with the specified IDs
        const fileBrowser = document.getElementById('file-browser');
        const browserWindow = document.getElementById('browser-window');
        const dropZone = document.getElementById('drop-zone');
        const instructionsPanel = document.getElementById('instructions-panel');
        const inlineSpinner = document.getElementById('inline-spinner');
        const currentLoanInfoContainer = document.getElementById('current-loan-info-container');
        const confirmGoalBtn = document.getElementById('confirm-goal-btn');
        const goalView = document.getElementById('goal-view');
        const findOffersBtn = document.getElementById('find-offers-btn');
        const offersView = document.getElementById('offers-view');
        const offersContainer = document.getElementById('offers-container');
        const fileItems = document.querySelectorAll('.file-item');
        const offerSelectionNotification = document.getElementById('offer-selection-notification');

        // Header Stats Elements
        const gameHeaderObjective = document.getElementById('game-objective');
        const statsLoansRefinanced = document.getElementById('stat-loans-refi');
        const statsRateSaved = document.getElementById('stat-rate-saved'); // Now shows average
        const statsPaymentReduced = document.getElementById('stat-payment-reduced');
        const statsCashOut = document.getElementById('stat-cash-out');

        // ==========================================
        //          MOCK DATA
        // ==========================================
        const mockExtractedData = {
            'office-loan-123-main.pdf': {
                property: { type: 'Commercial Office', location: '123 Main St, Cityville', sqft: '25,000 sq ft' },
                currentLoan: { balance: 2150000, interestRate: 5.85, monthlyPayment: 15980, remainingTermMonths: 24 * 12, originalAmount: 2500000, loanType: 'Refinance (Existing)', lender: 'City National Bank (Mock)' },
                borrower: { name: 'ABC Properties LLC', type: 'LLC', experience: '10+ Years' },
                guarantor: { name: 'John Smith', netWorth: '$5,000,000', creditScore: '750' }
            },
            'multifamily-loan-456-oak.pdf': {
                property: { type: 'Multifamily Apartment', location: '456 Oak Avenue, Townsville', sqft: '50 Units' },
                currentLoan: { balance: 4500000, interestRate: 6.20, monthlyPayment: 31500, remainingTermMonths: 8 * 12 + 6, originalAmount: 5000000, loanType: 'Purchase (Existing)', lender: 'Regional Creditors (Mock)' },
                borrower: { name: 'XYZ Holdings Inc.', type: 'Corporation', experience: '15+ Years' },
                guarantor: { name: 'Alice Johnson', netWorth: '$12,000,000', creditScore: '780' }
            },
            'warehouse-loan-789-ind.pdf': {
                property: { type: 'Industrial Warehouse', location: '789 Industrial Way, Factoryburg', sqft: '100,000 sq ft' },
                currentLoan: { balance: 8200000, interestRate: 5.50, monthlyPayment: 55800, remainingTermMonths: 6 * 12, originalAmount: 10000000, loanType: 'Refinance (Existing)', lender: 'Industrial Finance Co (Mock)' },
                borrower: { name: 'BuildFast Construction', type: 'Partnership', experience: '20+ Years' },
                guarantor: { name: 'Bob Williams & Partners', netWorth: '$25,000,000', creditScore: '800+' }
            },
            // --- Added 6 More Mock Files ---
            'retail-loan-101-plaza.pdf': {
                property: { type: 'Retail Strip Mall', location: '101 Plaza Dr, Shopperston', sqft: '15,000 sq ft' },
                currentLoan: { balance: 1800000, interestRate: 6.05, monthlyPayment: 12900, remainingTermMonths: 15 * 12, originalAmount: 2200000, loanType: 'Purchase (Existing)', lender: 'Commerce Bank (Mock)' },
                borrower: { name: 'Retail Ventures LLC', type: 'LLC', experience: '8+ Years' },
                guarantor: { name: 'Sarah Chen', netWorth: '$3,500,000', creditScore: '740' }
            },
            'hotel-loan-222-resort.pdf': {
                property: { type: 'Boutique Hotel', location: '222 Resort Ln, Vacationville', sqft: '30 Rooms' },
                currentLoan: { balance: 3100000, interestRate: 6.50, monthlyPayment: 21800, remainingTermMonths: 10 * 12, originalAmount: 4000000, loanType: 'Refinance (Existing)', lender: 'Hospitality Finance Group (Mock)' },
                borrower: { name: 'Sunset Resorts Inc.', type: 'Corporation', experience: '12+ Years' },
                guarantor: { name: 'Michael Davis', netWorth: '$8,000,000', creditScore: '765' }
            },
            'medical-office-loan-333-health.pdf': {
                property: { type: 'Medical Office Building', location: '333 Health Way, Doctortown', sqft: '18,000 sq ft' },
                currentLoan: { balance: 2850000, interestRate: 5.70, monthlyPayment: 18500, remainingTermMonths: 20 * 12, originalAmount: 3500000, loanType: 'Purchase (Existing)', lender: 'Healthcare Lenders (Mock)' },
                borrower: { name: 'MedInvest Partners', type: 'Partnership', experience: '18+ Years' },
                guarantor: { name: 'Dr. Emily Carter & Associates', netWorth: '$15,000,000', creditScore: '790' }
            },
            'storage-facility-loan-444-lock.pdf': {
                property: { type: 'Self-Storage Facility', location: '444 Lock St, Storageton', sqft: '500 Units' },
                currentLoan: { balance: 1200000, interestRate: 6.80, monthlyPayment: 9500, remainingTermMonths: 7 * 12, originalAmount: 1500000, loanType: 'Refinance (Existing)', lender: 'Secure Storage Capital (Mock)' },
                borrower: { name: 'LockTight Storage LLC', type: 'LLC', experience: '5+ Years' },
                guarantor: { name: 'David Rodriguez', netWorth: '$2,000,000', creditScore: '720' }
            },
            'student-housing-loan-555-uni.pdf': {
                property: { type: 'Student Housing Complex', location: '555 University Ave, Collegetown', sqft: '80 Beds' },
                currentLoan: { balance: 3900000, interestRate: 6.15, monthlyPayment: 27800, remainingTermMonths: 9 * 12, originalAmount: 4500000, loanType: 'Purchase (Existing)', lender: 'Campus Living Finance (Mock)' },
                borrower: { name: 'University Housing Solutions', type: 'Corporation', experience: '7+ Years' },
                guarantor: { name: 'Sophia Miller', netWorth: '$6,500,000', creditScore: '755' }
            },
            'mixed-use-loan-666-elm.pdf': {
                property: { type: 'Mixed-Use (Retail/Residential)', location: '666 Elm St, Downtown Crossing', sqft: '10 Units + 5 Shops' },
                currentLoan: { balance: 5500000, interestRate: 5.95, monthlyPayment: 37500, remainingTermMonths: 25 * 12, originalAmount: 6500000, loanType: 'Refinance (Existing)', lender: 'Urban Development Bank (Mock)' },
                borrower: { name: 'Elm Street Developments', type: 'Partnership', experience: '25+ Years' },
                guarantor: { name: 'Richard Baker & Family Trust', netWorth: '$30,000,000', creditScore: '810' }
            }
        };

        // ==========================================
        //          EVENT LISTENERS
        // ==========================================
        function setupEventListeners() {
            fileItems.forEach(file => {
                file.addEventListener('dragstart', handleDragStart);
                file.addEventListener('dragend', handleDragEnd);
                file.addEventListener('click', handleFileClick); // Add click handler
            });
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleDrop);
            dropZone.addEventListener('dragenter', handleDragEnter);
            dropZone.addEventListener('dragleave', handleDragLeave);
            confirmGoalBtn.addEventListener('click', handleConfirmAndSetGoal);
            findOffersBtn.addEventListener('click', handleFindOffers);
            offersContainer.addEventListener('click', handleSelectOffer);
        }

        // New function to handle file clicks
        function handleFileClick(e) {
            if (gameState.currentStep !== 0) {
                return; // Only allow selection in initial state
            }
            const fileItem = e.currentTarget;
            const fileName = fileItem.dataset.file;
            console.log("File clicked:", fileName);
            processSelectedFile(fileName);
        }

        // New function to handle file processing (used by both click and drop)
        function processSelectedFile(fileName) {
            if (!fileName || gameState.currentStep !== 0) {
                console.error("Invalid file or wrong game state");
                return;
            }

            const fileData = mockExtractedData[fileName];
            if (!fileData) {
                console.error("No data found for file:", fileName);
                alert("Error: Could not process data for this file.");
                return;
            }

            gameState.selectedFile = fileName;
            gameState.confirmedLoanData = fileData;

            console.log("Processing file:", fileName);
            
            // Update UI for processing state
            instructionsPanel.style.display = 'none';
            dropZone.style.display = 'none';
            inlineSpinner.style.display = 'block';
            currentLoanInfoContainer.style.display = 'block';
            clearInfoFields();
            confirmGoalBtn.disabled = true;

            // Start sequential population
            populateFieldsSequentially(fileData);
        }

        // ==========================================
        //          DRAG & DROP HANDLERS
        // ==========================================
        function handleDragStart(e) {
            // Only allow drag if in initial state
            if (gameState.currentStep === 0) {
                gameState.selectedFile = e.target.closest('.file-item').dataset.file;
                e.dataTransfer.setData('text/plain', gameState.selectedFile); // Necessary for Firefox
                e.target.closest('.file-item').classList.add('dragging'); // Add visual cue if needed
                console.log("Dragging:", gameState.selectedFile);
            } else {
                e.preventDefault(); // Prevent dragging if not in Step 0
            }
        }
        function handleDragEnd(e) {
             e.target.closest('.file-item').classList.remove('dragging');
        }

        function handleDragOver(e) {
            if (gameState.currentStep === 0) {
                e.preventDefault(); // Allow drop only in Step 0
                e.dataTransfer.dropEffect = 'copy';
                dropZone.classList.add('active');
            } else {
                 e.dataTransfer.dropEffect = 'none';
            }
        }

        function handleDragEnter(e) {
            if (gameState.currentStep === 0) {
                e.preventDefault();
                dropZone.classList.add('active');
            }
        }

        function handleDragLeave(e) {
            e.preventDefault();
            dropZone.classList.remove('active');
        }

        function handleDrop(e) {
            e.preventDefault();
            dropZone.classList.remove('active');

            if (gameState.selectedFile && gameState.currentStep === 0) {
                processSelectedFile(gameState.selectedFile);
            }
        }


        // ==========================================
        //          STEP 1: INLINE PROCESSING & CONFIRM
        // ==========================================
        function populateFieldsSequentially(fileData) {
            const fieldsToUpdate = [
                // Property
                { selector: '#current-loan-info-container .info-section:nth-of-type(1) .info-item:nth-of-type(1) .info-value', data: fileData.property.type },
                { selector: '#current-loan-info-container .info-section:nth-of-type(1) .info-item:nth-of-type(2) .info-value', data: fileData.property.location },
                { selector: '#current-loan-info-container .info-section:nth-of-type(1) .info-item:nth-of-type(3) .info-value', data: fileData.property.sqft },
                // Loan
                { selector: '#current-loan-info-container .info-section:nth-of-type(2) .info-item:nth-of-type(1) .info-value', data: currencyFormatter.format(fileData.currentLoan.balance) },
                { selector: '#current-loan-info-container .info-section:nth-of-type(2) .info-item:nth-of-type(2) .info-value', data: fileData.currentLoan.loanType },
                { selector: '#current-loan-info-container .info-section:nth-of-type(2) .info-item:nth-of-type(3) .info-value', data: `${fileData.currentLoan.remainingTermMonths} months` },
                { selector: '#current-loan-info-container .info-section:nth-of-type(2) .info-item:nth-of-type(4) .info-value', data: `${fileData.currentLoan.interestRate.toFixed(2)}%` },
                { selector: '#current-loan-info-container .info-section:nth-of-type(2) .info-item:nth-of-type(5) .info-value', data: currencyFormatter.format(fileData.currentLoan.monthlyPayment) },
                // Borrower
                { selector: '#current-loan-info-container .info-section:nth-of-type(3) .info-item:nth-of-type(1) .info-value', data: fileData.borrower.name },
                { selector: '#current-loan-info-container .info-section:nth-of-type(3) .info-item:nth-of-type(2) .info-value', data: fileData.borrower.type },
                { selector: '#current-loan-info-container .info-section:nth-of-type(3) .info-item:nth-of-type(3) .info-value', data: fileData.borrower.experience },
                // Guarantor
                { selector: '#current-loan-info-container .info-section:nth-of-type(4) .info-item:nth-of-type(1) .info-value', data: fileData.guarantor.name },
                { selector: '#current-loan-info-container .info-section:nth-of-type(4) .info-item:nth-of-type(2) .info-value', data: fileData.guarantor.netWorth }, // Assuming Net Worth is already formatted string
                { selector: '#current-loan-info-container .info-section:nth-of-type(4) .info-item:nth-of-type(3) .info-value', data: fileData.guarantor.creditScore },
            ];

            let delay = 0;
            const delayIncrement = 200; // ms between field updates

            fieldsToUpdate.forEach(field => {
                delay += delayIncrement;
                setTimeout(() => {
                    const element = document.querySelector(field.selector); // Use document.querySelector
                    if (element) {
                        element.textContent = field.data;
                        element.classList.add('highlight');
                        setTimeout(() => element.classList.remove('highlight'), 400); // Remove highlight
                    } else {
                        console.warn("Element not found for selector:", field.selector);
                    }
                }, delay);
            });

            // After all fields are scheduled, finish processing
            setTimeout(() => {
                inlineSpinner.style.display = 'none';
                confirmGoalBtn.disabled = false; // Enable confirm button
                gameState.currentStep = 1; // Mark as ready to confirm
                console.log("Inline processing complete. Ready to confirm.");
            }, delay + delayIncrement);
        }

        function handleConfirmAndSetGoal() {
            if (!gameState.confirmedLoanData || gameState.currentStep !== 1) {
                console.error("Cannot proceed: Not in correct state or data missing.");
                return;
            }
            console.log("Confirmed Loan Details:", gameState.confirmedLoanData);
            gameState.currentStep = 2; // Move to Step 2

            // Hide the Step 1 content (info sections) within the browser view
            currentLoanInfoContainer.style.display = 'none';

            // Show Step 2 Overlay
            showGoalView();
        }

        // ==========================================
        //          STEP 2: SET GOAL
        // ==========================================
        function showGoalView() {
            goalView.style.display = 'flex';
            // Default selection
            document.getElementById('goal-all').checked = true;
            requestAnimationFrame(() => {
                goalView.classList.add('visible');
            });
            console.log("Showing Step 2: Set Goal");
        }

        function handleFindOffers() {
            const selectedGoalInput = document.querySelector('input[name="refi-goal"]:checked');
            if (!selectedGoalInput) {
                console.error("No goal selected!");
                alert("Please select a refinancing goal.");
                return;
            }
            gameState.selectedGoal = selectedGoalInput.value;
            gameState.currentStep = 3;
            console.log("Selected Refinancing Goal:", gameState.selectedGoal);

            // Fade out Step 2 view
            goalView.classList.remove('visible');
            setTimeout(() => { goalView.style.display = 'none'; }, 400);

            // Generate and show offers
            console.log("Generating and showing offers...");
            const offers = generateOffers(gameState.confirmedLoanData.currentLoan, gameState.selectedGoal);
            gameState.lastGeneratedOffers = offers; // Store offers
            showOffersView(offers);
        }

        // ==========================================
        //          STEP 3: REVIEW OFFERS
        // ==========================================

        // --- MOCK OFFER GENERATION ---
        function calculateMockPayment(ratePercent, nperMonths, pv) {
            if (pv <= 0 || nperMonths <= 0) return 0;
            if (ratePercent <= 0) return pv / nperMonths;
            const monthlyRate = ratePercent / 100 / 12;
            const payment = pv * (monthlyRate * Math.pow(1 + monthlyRate, nperMonths)) / (Math.pow(1 + monthlyRate, nperMonths) - 1);
            return isNaN(payment) ? 0 : payment;
        }

        function getRandomRating() {
            const starRating = Math.round((Math.random() * 1.5 + 3.5) * 10) / 10;
            const ratingCount = Math.floor(Math.random() * 451) + 50;
            return { starRating, ratingCount };
        }

        function generateOffers(currentLoan, goal) {
            const offers = [];
            const baseLenderNames = ["Quantum Lending", "Stellar Finance", "Nebula Capital", "Cosmic Mortgages"];
            const numOffers = Math.floor(Math.random() * 2) + 2; // Generate 2-3 offers

            for (let i = 0; i < numOffers; i++) {
                let lenderName = baseLenderNames[i % baseLenderNames.length];
                let newRate = currentLoan.interestRate - (Math.random() * 0.75 + 0.1); // Base rate reduction
                let cashOut = 0;
                let newLoanAmount = currentLoan.balance;
                const newTermMonths = 30 * 12;

                if (goal === 'rate') {
                    newRate -= Math.random() * 0.4; // Prioritize lower rate
                } else if (goal === 'cashout') {
                    // Allow LTV up to, say, 75% of an estimated property value
                    // Estimate value crudely based on current balance and assumed ~60-70% LTV
                    let estimatedValue = currentLoan.balance / (0.6 + Math.random() * 0.1);
                    let maxLoan = estimatedValue * (0.70 + Math.random() * 0.05); // Target 70-75% LTV
                    newLoanAmount = Math.max(currentLoan.balance, Math.round(maxLoan / 1000) * 1000); // Round to nearest 1k
                    cashOut = newLoanAmount - currentLoan.balance;
                    newRate += Math.random() * 0.35; // Rate bump for cash out
                } else { // 'all' offers
                    if (Math.random() > 0.5) { // 50% chance of some cash out
                        let estimatedValue = currentLoan.balance / (0.6 + Math.random() * 0.1);
                        let maxLoan = estimatedValue * (0.65 + Math.random() * 0.05); // Target 65-70% LTV
                         newLoanAmount = Math.max(currentLoan.balance, Math.round(maxLoan / 1000) * 1000);
                         cashOut = newLoanAmount - currentLoan.balance;
                         newRate += Math.random() * 0.20; // Slight rate bump
                    }
                }

                newRate = Math.max(3.5, newRate); // Floor rate
                let newPayment = calculateMockPayment(newRate, newTermMonths, newLoanAmount);
                const rating = getRandomRating();

                offers.push({
                    id: `offer-${i}-${Date.now()}`,
                    lenderName: lenderName,
                    newLoanAmount: newLoanAmount,
                    newInterestRate: newRate,
                    newMonthlyPayment: Math.round(newPayment),
                    cashOut: cashOut > 0 ? cashOut : 0,
                    starRating: rating.starRating,
                    ratingCount: rating.ratingCount
                });
            }
            console.log("Generated Offers:", offers);
            return offers;
        }

        // --- DISPLAY OFFERS ---
        function showOffersView(offers) {
            offersContainer.innerHTML = ''; // Clear previous

            if (!offers || offers.length === 0) {
                offersContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; grid-column: 1 / -1;">No suitable refinance offers found.</p>';
            } else {
                const currentLoan = gameState.confirmedLoanData.currentLoan;

                offers.forEach(offer => {
                    const amountDiff = offer.newLoanAmount - currentLoan.balance;
                    const rateDiff = offer.newInterestRate - currentLoan.interestRate;
                    const paymentDiff = offer.newMonthlyPayment - currentLoan.monthlyPayment;

                    const amountDiffClass = amountDiff > 0 ? 'positive' : (amountDiff < 0 ? 'negative' : '');
                    const rateDiffClass = rateDiff > 0 ? 'negative' : (rateDiff < 0 ? 'positive' : '');
                    const paymentDiffClass = paymentDiff > 0 ? 'negative' : (paymentDiff < 0 ? 'positive' : '');

                    // Star display logic
                    const fullStars = Math.floor(offer.starRating);
                    const halfStar = offer.starRating % 1 >= 0.5 ? 1 : 0; // Simple half-star logic
                    const emptyStars = Math.max(0, 5 - fullStars - halfStar);
                    // Using text symbols for stars - ensure font supports them well
                    const starsHtml = `<span class="stars">${'â˜…'.repeat(fullStars)}${halfStar ? 'Â½' : ''}${'â˜†'.repeat(emptyStars)}</span>`; 


                    const card = document.createElement('div');
                    card.className = 'offer-card';
                    // Use textContent for safety, format numbers
                    card.innerHTML = `
                        <h4></h4>
                        <div class="rating">
                             ${starsHtml}
                             <span></span> <!-- Placeholder for text -->
                        </div>
                        <div class="offer-details">
                            <span class="label">New Loan Amount:</span>
                            <span class="value amount"></span>

                            <span class="label">Interest Rate:</span>
                            <span class="value rate"></span>

                            <span class="label">Monthly P&I:</span>
                            <span class="value payment"></span>

                            <span class="label">Cash Out Received:</span>
                            <span class="value cashout"></span>
                        </div>
                        <div class="select-btn-container">
                            <button class="btn btn-success select-offer-btn" data-offer-id="${offer.id}">Select Offer</button>
                         </div>
                    `;

                     // Safely set text content
                    card.querySelector('h4').textContent = offer.lenderName;
                    card.querySelector('.rating span:last-child').textContent = `(${offer.starRating.toFixed(1)} stars, ${offer.ratingCount} reviews)`;
                    card.querySelector('.value.amount').textContent = currencyFormatter.format(offer.newLoanAmount);
                    card.querySelector('.value.rate').textContent = `${offer.newInterestRate.toFixed(2)}%`;
                    card.querySelector('.value.payment').textContent = currencyFormatter.format(offer.newMonthlyPayment);
                    card.querySelector('.value.cashout').textContent = currencyFormatter.format(offer.cashOut);


                    // Add difference indicators safely
                    if (amountDiff !== 0) {
                        const diffSpan = document.createElement('span');
                        diffSpan.className = `difference ${amountDiffClass}`;
                        diffSpan.textContent = `(${amountDiff > 0 ? '+' : ''}${currencyFormatter.format(amountDiff)})`;
                        card.querySelector('.value.amount').appendChild(diffSpan);
                    }
                     if (rateDiff.toFixed(2) !== '0.00' && rateDiff.toFixed(2) !== '-0.00') { // Check difference precisely
                        const diffSpan = document.createElement('span');
                        diffSpan.className = `difference ${rateDiffClass}`;
                        diffSpan.textContent = `(${rateDiff > 0 ? '+' : ''}${rateDiff.toFixed(2)}%)`;
                         card.querySelector('.value.rate').appendChild(diffSpan);
                    }
                     if (paymentDiff !== 0) {
                        const diffSpan = document.createElement('span');
                        diffSpan.className = `difference ${paymentDiffClass}`;
                        diffSpan.textContent = `(${paymentDiff > 0 ? '+' : ''}${currencyFormatter.format(paymentDiff)})`;
                         card.querySelector('.value.payment').appendChild(diffSpan);
                    }


                    offersContainer.appendChild(card);
                });
            }

            // Fade in the offers view
            offersView.style.display = 'flex';
            requestAnimationFrame(() => {
                offersView.classList.add('visible');
            });
             console.log("Showing Step 3: Review Offers");
        }

        // --- STEP 3 HANDLERS ---
        function handleSelectOffer(event) {
            console.log("handleSelectOffer started..."); // Log start
            const targetButton = event.target.closest('.select-offer-btn');
            if (!targetButton || targetButton.disabled) {
                console.log("handleSelectOffer: No valid button found or button disabled."); // Log exit
                return;
            }

            const offerId = targetButton.dataset.offerId;
            console.log("handleSelectOffer: Found offer ID:", offerId); // Log ID
            const selectedOffer = gameState.lastGeneratedOffers.find(offer => offer.id === offerId);

            if (!selectedOffer) {
                console.error("Selected offer data not found for ID:", offerId);
                return;
            }

            console.log("Selected Offer:", selectedOffer); // Log selected offer data
            const originalLoan = gameState.confirmedLoanData.currentLoan;

            console.log("handleSelectOffer: Updating stats..."); // Log before stats
            // --- Update Game Stats --- 
            gameState.stats.loansRefinanced++;
            const rateSaved = originalLoan.interestRate - selectedOffer.newInterestRate;
            const paymentReduced = originalLoan.monthlyPayment - selectedOffer.newMonthlyPayment;
            gameState.stats.totalRateSaved += rateSaved;
            gameState.stats.totalPaymentReduced += paymentReduced;
            gameState.stats.totalCashOut += selectedOffer.cashOut;
            // Calculate new average rate saved
            gameState.stats.avgRateSaved = gameState.stats.totalRateSaved / gameState.stats.loansRefinanced;

            updateStatsDisplay();
            console.log("handleSelectOffer: Stats updated."); // Log after stats
            // --- End Update Game Stats ---

            console.log("handleSelectOffer: Showing notification..."); // Log before notification
            // Show the custom notification
            offerSelectionNotification.textContent = `Offer from ${selectedOffer.lenderName} selected! Stats updated.`;
            offerSelectionNotification.style.display = 'block';

            // Hide the notification after a few seconds
            setTimeout(() => {
                console.log("handleSelectOffer: Hiding notification (timeout)."); // Log notification hide
                offerSelectionNotification.style.display = 'none';
            }, 4000); // Hide after 4 seconds
            console.log("handleSelectOffer: Notification shown, timeout set."); // Log after notification

            console.log("handleSelectOffer: Updating controls visibility..."); // Log before controls
            // Show 'Process Another Loan' button, hide 'Cancel' from offers view?
            offersView.querySelector('.game-controls .btn-secondary').style.display = 'none'; // Hide Cancel button
            offersView.querySelector('.game-controls .btn-primary').style.display = 'inline-block'; // Ensure Process Another is visible
            console.log("handleSelectOffer: Controls visibility updated."); // Log after controls

            console.log("handleSelectOffer: Disabling other offer buttons..."); // Log before loop
            // Disable further offer selection? Maybe grey out other cards?
            offersContainer.querySelectorAll('.select-offer-btn').forEach(btn => {
                btn.disabled = true;
                btn.textContent = 'Selected';
                btn.style.opacity = 0.7;
            });
            console.log("handleSelectOffer: Other buttons disabled."); // Log after loop

            console.log("handleSelectOffer: Updating selected button..."); // Log before final update
            // Consistently use targetButton found via closest()
            targetButton.textContent = 'âœ“ Selected'; 
            targetButton.style.opacity = 1; 
            targetButton.disabled = true; 
            console.log("handleSelectOffer: Selected button updated. Function finished."); // Log end

        }

        function handleProcessAnotherLoan() {
            hideAllViews();
            initGame(); // Reset the game for the next loan
            // Ensure new files are generated for the next round
            populateFileBrowser();
        }

        // ==========================================
        //          UTILITY & INITIALIZATION
        // ==========================================
        function clearInfoFields() {
            const infoValues = document.querySelectorAll('#current-loan-info-container .info-value');
            infoValues.forEach(el => el.textContent = '- - -');
        }

        function updateStatsDisplay() {
            if (!statsLoansRefinanced) { // Basic check if header exists
                 console.warn("Stats header elements not found.");
                 return;
            }
            statsLoansRefinanced.textContent = gameState.stats.loansRefinanced;
            // Format average rate saved - show '+' if it's an increase (negative saving)
            const avgRateDisplay = gameState.stats.loansRefinanced > 0 
                                    ? (gameState.stats.avgRateSaved > 0 ? '-' : '+') + Math.abs(gameState.stats.avgRateSaved).toFixed(2) + '%'
                                    : '-0.00%'; // Handle division by zero
            statsRateSaved.textContent = avgRateDisplay;
            statsRateSaved.className = `stat-value ${gameState.stats.avgRateSaved >= 0 ? 'positive' : 'negative'}`; // Green if rate saved >= 0

            // Format total payment reduced
            const paymentDisplay = currencyFormatter.format(Math.abs(gameState.stats.totalPaymentReduced));
            statsPaymentReduced.textContent = `${gameState.stats.totalPaymentReduced >= 0 ? '-' : '+'}${paymentDisplay}`;
            statsPaymentReduced.className = `stat-value ${gameState.stats.totalPaymentReduced >= 0 ? 'positive' : 'negative'}`; // Green if reduction > 0

            // Format total cash out
            statsCashOut.textContent = currencyFormatter.format(gameState.stats.totalCashOut);
            console.log("Stats Updated:", gameState.stats);
        }

        function initGame() {
            console.log("Initializing game for next loan..."); // Clarify purpose
            // Preserve existing stats
            const currentStats = gameState.stats;

            // Reset only the per-loan state
            gameState = {
                currentStep: 0,
                selectedFile: null,
                confirmedLoanData: null,
                selectedGoal: null,
                lastGeneratedOffers: [],
                stats: currentStats // Restore the existing stats
            };

            // Ensure overlays are hidden
            goalView.classList.remove('visible');
            offersView.classList.remove('visible');
            goalView.style.display = 'none';
            offersView.style.display = 'none';

            // Set initial UI state for browser content
            fileBrowser.style.display = 'flex';
            browserWindow.style.display = 'flex';
            instructionsPanel.style.display = 'block';
            dropZone.style.display = 'flex';
            currentLoanInfoContainer.style.display = 'none';
            inlineSpinner.style.display = 'none';

            confirmGoalBtn.disabled = true;
            // Ensure offers buttons are re-enabled if game restarts
             if(offersContainer) offersContainer.querySelectorAll('.select-offer-btn').forEach(btn => btn.disabled = false);
            clearInfoFields();
            updateStatsDisplay();

            // No need to setup listeners again if using DOMContentLoaded once
            console.log("Game Initialized and ready for next loan.");
        }

        // Start the game
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners(); // Setup listeners once DOM is ready
            initGame(); // Initialize game state
            populateFileBrowser(); // Explicitly populate the file browser
            console.log("Game initialized and file browser populated");
        });

        // Function to populate file browser
        function populateFileBrowser() {
            console.log("--- Starting populateFileBrowser ---");
            const fileItemList = document.querySelector('.file-item-list');
            if (!fileItemList) {
                console.error("File item list container not found!");
                return;
            }

            fileItemList.innerHTML = '';
            console.log("Cleared file item list.");

            const availableFiles = Object.keys(mockExtractedData);
            const shuffledFiles = [...availableFiles].sort(() => Math.random() - 0.5);
            const numFilesToShow = Math.min(9, shuffledFiles.length);

            for (let i = 0; i < numFilesToShow; i++) {
                const fileNameKey = shuffledFiles[i];
                const fileData = mockExtractedData[fileNameKey];
                
                if (!fileData) {
                    console.warn(`No data found for file: ${fileNameKey}`);
                    continue;
                }

                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.draggable = true;
                fileItem.dataset.file = fileNameKey;
                fileItem.role = 'button';
                fileItem.tabIndex = '0';

                fileItem.innerHTML = `
                    <div class="file-icon">ðŸ“„</div>
                    <div class="file-name">${fileNameKey.replace(/[-_]/g, ' ')
                        .replace(/\.pdf$/i, '')
                        .split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ')}.pdf</div>
                `;

                // Add event listeners
                fileItem.addEventListener('dragstart', handleDragStart);
                fileItem.addEventListener('dragend', handleDragEnd);
                fileItem.addEventListener('click', handleFileClick);
                
                // Add keyboard support
                fileItem.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        handleFileClick(e);
                    }
                });

                fileItemList.appendChild(fileItem);
            }
        }

        // Added missing function for the Cancel button in offers view
        function handleCancelOffers() {
            console.log("Cancelling offers view...");
            hideAllViews();
            // Show the goal selection view again
            showGoalView();
            // Ensure the buttons in the offer view are reset in case they were hidden/disabled
            offersView.querySelector('.game-controls .btn-secondary').style.display = 'inline-block';
            offersView.querySelector('.game-controls .btn-primary').style.display = 'inline-block';
        }

        // Helper function to hide overlay views
        function hideAllViews() {
            const views = [goalView, offersView]; // Add other overlay views here if created
            views.forEach(view => {
                if (view) {
                    view.classList.remove('visible');
                    // Use setTimeout to allow fade-out transition before setting display: none
                    setTimeout(() => {
                        view.style.display = 'none';
                    }, 400); // Match transition duration
                }
            });
             // Also hide the notification if it's visible
             if (offerSelectionNotification) {
                 offerSelectionNotification.style.display = 'none';
             }
            console.log("Hiding all overlay views.");
        }

    </script>
</body>
</html>