<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- TITLE UPDATED -->
    <title>The RefiHub Game: Build Your Empire. Buy, Refi, Repeat.</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- Base Styles & Variables --- */
        :root {
            --bg-primary: #111827; /* Dark Gray/Navy */
            --bg-secondary: #1f2937; /* Medium Dark Gray/Navy */
            --bg-tertiary: #374151; /* Lighter Gray */
            --border-color: #4b5563; /* Gray Border */
            --text-primary: #f3f4f6; /* Light Gray/White Text */
            --text-secondary: #9ca3af; /* Medium Gray Text */
            --text-tertiary: #6b7280; /* Darker Gray Text */
            --accent-blue: #3b82f6; /* Bright Blue */
            --accent-gold: #f59e0b; /* Gold/Amber */
            --accent-green: #22c55e; /* Bright Green */
            --accent-red: #ef4444; /* Bright Red */
            --accent-cyan: #22d3ee; /* Cyan */
            --accent-pink: #ec4899; /* Pink */
            --accent-purple: #a855f7; /* Purple */
            --shadow-color: rgba(0, 0, 0, 0.4); /* Darker shadow */
            --dscr-good: var(--accent-green);
            --dscr-ok: var(--accent-gold);
            --dscr-bad: var(--accent-red);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 14px; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #game-container {
            width: 100%;
            max-width: 1400px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px -5px var(--shadow-color);
            padding: 1.5rem 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* --- Header --- */
        #header { display: flex; flex-direction: column; gap: 0.75rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        #header-top { text-align: center; margin-bottom: 0.25rem; display: flex; flex-direction: column; gap: 0.25rem; }
        #header-top h1 { font-size: 1.5rem; font-weight: 800; color: #ffffff; letter-spacing: -0.02em; margin-bottom: 0; }
        .game-slogan { font-size: 1.1rem; font-weight: 600; color: var(--accent-gold); margin-top: 0.1rem; margin-bottom: 0.1rem; }
        #game-subtitle { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4; }
        .cta-link { font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.3rem; }
        .cta-link a { color: var(--accent-cyan); text-decoration: none; font-weight: 500; }
        .cta-link a:hover { text-decoration: underline; }
        #stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 0.75rem; }
        .status-item { background-color: var(--bg-primary); padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.375rem; transition: background-color 0.3s ease; text-align: left; }
        .status-item .label { font-size: 0.7rem; color: var(--text-secondary); display: block; margin-bottom: 0.15rem; font-weight: 500; }
        .status-item span:not(.label) { color: var(--text-primary); display: block; font-size: 1.0rem; font-weight: 600; overflow-wrap: break-word; min-height: 1.1rem; }
        .status-item span.positive { color: var(--accent-green); }
        .status-item span.negative { color: var(--accent-red); }
        .status-item.highlight { background-color: var(--bg-tertiary); animation: highlight-anim 0.6s ease-out; }
        @keyframes highlight-anim { 0% { transform: scale(1); } 50% { transform: scale(1.03); background-color: #4b5563; } 100% { transform: scale(1); } }
        #level-display { grid-column: 1 / -1; text-align: center; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed var(--border-color); }
        #level-display .label { display: inline; margin-right: 0.5rem; font-size: 0.8rem; }
        #level-icon { font-size: 1.5rem; vertical-align: middle; margin: 0 0.5rem; display: inline-block; }
        #level-text { font-weight: 600; color: var(--accent-gold); font-size: 1rem; }
        #goal-progress { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; }

        /* --- Main Layout --- */
        #main-layout { display: grid; grid-template-columns: 1fr 300px; gap: 1.5rem; }
        #content-area { display: flex; flex-direction: column; gap: 1.5rem; }
        #sidebar-area { display: flex; flex-direction: column; gap: 1rem; }

        /* --- Graphs (Sidebar) --- */
        .graph-widget { background-color: var(--bg-primary); border: 1px solid var(--border-color); padding: 0.75rem; border-radius: 0.375rem; }
        .graph-header { margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: baseline;}
        .graph-header h3 { font-size: 0.75rem; color: var(--text-secondary); }
        .graph-current-value { font-size: 0.9rem; font-weight: 600; }
        .graph-current-value.positive { color: var(--accent-green); }
        .graph-current-value.negative { color: var(--accent-red); }
        .graph-svg { height: 80px; width: 100%; display: block; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.25rem;}
        .graph-footer { font-size: 0.65rem; margin-top: 0.3rem; text-align: center; color: var(--text-tertiary);}
        .graph-line { fill: none; stroke-width: 1.5px; vector-effect: non-scaling-stroke;}
        .axis-label { font-family: 'Inter', sans-serif; font-size: 0.6rem; fill: var(--text-tertiary); }
        .rate-line { stroke: var(--accent-blue); } .value-line { stroke: var(--accent-gold); } .rent-line { stroke: var(--accent-purple); } .networth-line { stroke: var(--accent-green); } .cashflow-line { stroke: var(--accent-cyan); }

        /* --- Sections & Cards --- */
        .section-title { font-size: 1.15rem; font-weight: 700; color: #ffffff; margin-bottom: 1rem; text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; }
        .card { border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; box-shadow: 0 2px 4px var(--shadow-color); transition: transform 0.2s ease, box-shadow 0.2s ease; background-color: var(--bg-secondary); font-size: 0.75rem; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-color); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .card h3 { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
        .card-icon { font-size: 1.25rem; }
        .card p { display: flex; justify-content: space-between; color: var(--text-secondary); line-height: 1.4; }
        .card p .label { color: var(--text-tertiary); margin-right: 0.5rem; flex-shrink: 0; }
        .card p span:not(.label) { font-weight: 500; color: var(--text-primary); text-align: right; }
        .value-info { display: flex; align-items: center; justify-content: flex-end; }
        .value-info .trend-indicator { margin-left: 0.25rem; font-size: 0.7rem; }
        .trend-indicator { display: inline-block; width: 1em; text-align: center; }
        .trend-up { color: var(--accent-green); } .trend-down { color: var(--accent-red); } .trend-stable { color: var(--text-tertiary); }
        .dscr-value.good { color: var(--dscr-good); font-weight: 600; } .dscr-value.ok { color: var(--dscr-ok); font-weight: 600;} .dscr-value.bad { color: var(--dscr-bad); font-weight: 600;}

        /* --- Properties Section Specifics --- */
        #properties-area { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; align-content: start; min-height: 150px; }
        .property-card { border-left: 4px solid var(--accent-blue); }
        .property-card h3 { color: var(--accent-blue); }
        .property-actions { margin-top: 0.75rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }

        /* --- Marketplace Section Specifics --- */
        #marketplace-section { min-height: 120px; background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        #marketplace-section h2 { font-size: 1.15rem; font-weight: 700; color: #ffffff; text-align: center; margin-bottom: 0.5rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: center; align-items: center; flex-wrap: wrap; }
        #marketplace-section h2 .subtitle { font-weight: 400; font-size: 0.9rem; color: var(--text-secondary); margin-left: 0.5rem; }
        #marketplace-section h2 .marketplace-refresh-inline { display: inline-flex; margin-left: 1rem; vertical-align: middle; }
        #marketplace-area { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; min-height: 150px; align-content: start; }
        .marketplace-card { border-left: 4px solid var(--accent-gold); }
        .marketplace-card h3 { color: var(--accent-gold); }
        .marketplace-card .btn-buy { margin-top: 0.75rem; width: 100%; }

        /* --- Offers Section (REVISED LAYOUT & WIDTH FIX) --- */
        #offers-area, #marketplace-section { min-height: 120px; background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        #offers-area h2, #marketplace-section h2 { font-size: 1.15rem; font-weight: 700; color: #ffffff; text-align: center; margin-bottom: 0.5rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: center; align-items: center; flex-wrap: wrap; }
        #offers-area h2 .subtitle { font-weight: 400; font-size: 0.9rem; color: var(--text-secondary); margin-left: 0.5rem; }
        #offers-area h2 .offer-toggles-inline { display: inline-flex; gap: 0.5rem; margin-left: 1rem; vertical-align: middle; }
        #marketplace-section h2 .subtitle { font-weight: 400; font-size: 0.9rem; color: var(--text-secondary); margin-left: 0.5rem; }
        #marketplace-section h2 .marketplace-refresh-inline { display: inline-flex; margin-left: 1rem; vertical-align: middle; }
        #offers-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); /* Use auto-fill to prevent single item stretch */
            gap: 1rem;
            align-content: start; /* Align cards to the top, prevents stretching vertically */
        }
        #no-offers-message { grid-column: 1 / -1; text-align: center; font-size: 0.8rem; color: var(--accent-green); padding: 1rem; border: 1px dashed var(--accent-green); border-radius: 0.25rem; animation: pulse-green 2s infinite ease-in-out; display: none; }
        @keyframes pulse-green { 0%, 100% { opacity: 0.7; box-shadow: 0 0 3px rgba(34, 197, 94, 0.3); } 50% { opacity: 1; box-shadow: 0 0 8px rgba(34, 197, 94, 0.5); } }
        .offer-card { /* Uses .card styles + offer specifics */ display: flex; flex-direction: column; gap: 0.4rem; padding: 0.8rem; }
        .offer-card-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.4rem; padding-bottom: 0.4rem; border-bottom: 1px solid var(--border-color); }
        .offer-card h3 { font-size: 0.9rem; font-weight: 600; }
        .offer-source { font-size: 0.65rem; color: var(--text-tertiary); font-style: italic; }
        .offer-card-body { display: grid; grid-template-columns: auto 1fr; gap: 0.2rem 0.8rem; align-items: center; }
        .offer-card-body .label { color: var(--text-tertiary); text-align: left; white-space: nowrap; }
        .offer-card-body span:not(.label) { font-weight: 500; color: var(--text-primary); text-align: right; }
        .offer-card-body .rate-info { font-size: 0.7rem; color: var(--text-secondary); margin-left: 0.2rem; }
        /* CASH OUT COLOR */
        .offer-card-body span.cash-out-positive { color: var(--accent-cyan); font-weight: 600; }
        .offer-card-body .dscr-value { font-weight: 600; } /* Re-apply DSCR colors */
        .offer-card-footer { margin-top: 0.6rem; padding-top: 0.4rem; border-top: 1px dashed var(--border-color); display: flex; flex-direction: column; gap: 0.5rem; }
        .offer-costs { display: flex; justify-content: space-between; font-size: 0.7rem; }
        .offer-costs .label { color: var(--text-tertiary); }
        .offer-costs .cost-value { color: var(--accent-red); font-weight: 500; }
        .offer-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .offer-card.offer-type-refinance { border-left: 4px solid var(--accent-blue); }
        .offer-card.offer-type-refinance-quote { border-left: 4px solid var(--text-tertiary); }

        /* --- Message Log --- */
        #message-log-container { }
        #message-log-container h2 { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; text-align: center; }
        #message-log { height: 150px; background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 0.25rem; padding: 0.75rem; overflow-y: auto; font-size: 0.7rem; color: var(--text-secondary); line-height: 1.5; }
        #message-log p { margin-bottom: 0.3rem; border-bottom: 1px solid var(--bg-tertiary); padding-bottom: 0.3rem; }
        #message-log p:last-child { border-bottom: none; }
        .log-info { color: var(--text-tertiary); } .log-offer { color: var(--accent-gold); } .log-action { color: var(--accent-blue); } .log-warning { color: #facc15; } .log-success { color: var(--accent-green); } .log-buy-sell { color: var(--accent-pink); } .log-error { color: var(--accent-red); font-weight: bold;}

        /* --- Buttons --- */
        button { font-family: 'Inter', sans-serif; font-size: 0.75rem; padding: 0.5rem 0.9rem; border: 1px solid transparent; cursor: pointer; transition: all 0.15s ease; text-transform: none; border-radius: 0.375rem; font-weight: 600; box-shadow: 0 1px 2px 0 var(--shadow-color); display: inline-flex; align-items: center; gap: 0.3rem; justify-content: center; font-variant-ligatures: none; -webkit-font-variant-ligatures: none; text-rendering: optimizeLegibility; }
        button:disabled { cursor: not-allowed; opacity: 0.5; background-color: var(--bg-tertiary) !important; border-color: var(--border-color) !important; color: var(--text-tertiary) !important; }
        button:active:not(:disabled) { transform: translateY(1px); }
        .btn-primary { background-color: var(--accent-blue); border-color: var(--accent-blue); color: #ffffff; } .btn-primary:hover:not(:disabled) { background-color: #2563eb; border-color: #1d4ed8; }
        .btn-secondary { background-color: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); } .btn-secondary:hover:not(:disabled) { background-color: var(--border-color); }
        .btn-danger { background-color: var(--accent-red); border-color: var(--accent-red); color: #ffffff; } .btn-danger:hover:not(:disabled) { background-color: #dc2626; border-color: #b91c1c; }
        .btn-success { background-color: var(--accent-green); border-color: var(--accent-green); color: #ffffff; } .btn-success:hover:not(:disabled) { background-color: #16a34a; border-color: #15803d; }
        .btn-warning { background-color: var(--accent-gold); border-color: var(--accent-gold); color: var(--bg-primary); } .btn-warning:hover:not(:disabled) { background-color: #d97706; border-color: #b45309; }
        .btn-refi { width: 100%; background-color: var(--accent-blue); border-color: var(--accent-blue); color: #ffffff; } .btn-refi:hover:not(:disabled) { background-color: #2563eb; border-color: #1d4ed8; }
        .btn-sell { width: 100%; background-color: var(--accent-pink); border-color: var(--accent-pink); color: #ffffff; } .btn-sell:hover:not(:disabled) { background-color: #db2777; border-color: #be185d; }
        .btn-buy { width: 100%; background-color: var(--accent-green); border-color: var(--accent-green); color: #ffffff; } .btn-buy:hover:not(:disabled) { background-color: #16a34a; border-color: #15803d; }
        .btn-refresh { background-color: var(--accent-purple); border-color: var(--accent-purple); color: #ffffff; } .btn-refresh:hover:not(:disabled) { background-color: #9333ea; border-color: #7e22ce; }
        .btn-accept { background-color: var(--accent-green); border-color: var(--accent-green); color: #ffffff; width: 100%;} .btn-accept:hover:not(:disabled) { background-color: #16a34a; border-color: #15803d; }
        .btn-reject { background-color: var(--accent-red); border-color: var(--accent-red); color: #ffffff; width: 100%; } .btn-reject:hover:not(:disabled) { background-color: #dc2626; border-color: #b91c1c; }

        /* --- Game Over / Win Overlay --- */
        #game-over-overlay { position: fixed; inset: 0; background-color: rgba(17, 24, 39, 0.95); color: #f9fafb; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; z-index: 100; font-size: 1rem; padding: 2rem; backdrop-filter: blur(5px); }
        #game-over-overlay h2 { font-size: 2rem; margin-bottom: 1.5rem; font-weight: 700; }
        #game-over-overlay p { margin-bottom: 1.5rem; line-height: 1.6; color: #d1d5db; }
        #game-over-title.win { color: var(--accent-green); } #game-over-title.lose { color: var(--accent-red); }
        #restart-btn { font-size: 1rem; padding: 0.75rem 1.5rem; background-color: var(--accent-blue); border-color: var(--accent-blue); color: #ffffff; }
        #restart-btn:hover { background-color: #2563eb; border-color: #1d4ed8; }

        /* --- Responsive Adjustments --- */
        @media (max-width: 1200px) { #stats-grid { grid-template-columns: repeat(auto-fit, minmax(105px, 1fr)); } }
        @media (max-width: 900px) { #main-layout { grid-template-columns: 1fr; } #sidebar-area { order: 1; margin-top: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; } #stats-grid { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); } #message-log { height: 130px; } #message-log-container { grid-column: 1 / -1; margin-top: 0.5rem; } #offers-list { grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); } }
        @media (max-width: 600px) { html { font-size: 13px; } #game-container { padding: 1rem; } #header { gap: 0.75rem; } #stats-grid { gap: 0.5rem; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); } .status-item { padding: 0.5rem; } .status-item span:not(.label) { font-size: 0.85rem; min-height: 1rem;} #level-display { margin-top: 0.25rem; padding-top: 0.25rem;} #level-icon { font-size: 1.2rem; } #level-text { font-size: 0.9rem; } #goal-progress { font-size: 0.7rem; } #properties-area, #marketplace-area, #offers-list { grid-template-columns: 1fr; } button { padding: 0.4rem 0.8rem; font-size: 0.7rem; } #game-over-overlay h2 { font-size: 1.5rem; } #sidebar-area { grid-template-columns: 1fr; } #message-log { height: 120px; } }

        /* Toggle Button Styles */
        .toggle-btn { background-color: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-secondary); padding: 0.4rem 0.8rem; font-size: 0.7rem; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        .toggle-btn:hover:not(:disabled) { background-color: var(--border-color); color: var(--text-primary); }
        .toggle-btn.active { background-color: var(--accent-blue); border-color: var(--accent-blue); color: #ffffff; box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
        .toggle-btn.active:hover:not(:disabled) { background-color: #2563eb; }

    </style>
</head>
<body>

    <div id="game-container">
        <!-- Header Section -->
        <header id="header">
            <div id="header-top">
                <h1>RefiHub Simulator: Grow your real estate empire.</h1>
                <p class="game-slogan">Buy. Refi. Repeat.</p>
                <p id="game-subtitle">Grow your cash flow. Maximize your lifestyle. Achieve total financial freedom.</p>
                <p class="cta-link">Want to do this in real life? Visit <a href="https://refihub.com" target="_blank">RefiHub.com</a> to start building your real RefiHub.</p>
            </div>
            <div id="stats-grid">
                 <div class="status-item"><span class="label">Date:</span> <span id="time-display">Loading...</span></div>
                 <div class="status-item"><span class="label">Properties:</span> <span id="prop-count-display">0 / 9</span></div>
                 <div class="status-item"><span class="label">Total AUM:</span> <span id="total-aum-display">$0</span></div>
                 <div class="status-item"><span class="label">Net Worth:</span> <span id="net-worth-display">$0</span></div>
                 <div class="status-item"><span class="label">Cash:</span> <span id="cash-display">$0</span></div>
                 <div class="status-item"><span class="label">Total Loans:</span> <span id="total-loan-display">$0</span></div>
                 <div class="status-item"><span class="label">Avg Loan Rate:</span> <span id="avg-rate-display">0%</span></div>
                 <div class="status-item"><span class="label">Yearly NOI:</span> <span id="total-noi-display">$0</span></div>
                 <div class="status-item"><span class="label">Yearly Debt Svc:</span> <span id="total-debt-service-display">$0</span></div>
                 <div class="status-item"><span class="label">Portfolio DSCR:</span> <span id="portfolio-dscr-display">N/A</span></div>
                 <div class="status-item"><span class="label">Yearly Cash Flow:</span> <span id="last-cashflow-display">$0</span></div>
            </div>
            <div id="level-display">
                 <span class="label">Lifestyle Level:</span>
                 <span id="level-icon">💰</span> <span id="level-text">Starting Out</span>
                 <div id="goal-progress">Goal: $100K / Yr CF</div>
            </div>
        </header>

        <!-- Main Content Layout -->
        <div id="main-layout">
            <!-- Content Area -->
            <div id="content-area">
                <!-- Refinance Offers Section -->
                <section id="offers-area">
                    <h2>
                        Refinance Offers <span class="subtitle">via RefiHub Loan Marketplace</span>
                        <span class="offer-toggles-inline">
                            <button class="toggle-btn" id="lower-rate-offers-toggle" title="Activate RefiHub alerts for offers strictly better than your current rate.">Best Rate Alerts</button>
                            <button class="toggle-btn" id="cash-out-offers-toggle" title="Activate RefiHub alerts for offers maximizing cash out (may have similar/higher rate).">Max Cash-Out Alerts</button>
                        </span>
                    </h2>
                    <div id="offers-list">
                        <div id="no-offers-message" style="display: block;">
                            Automated Refinance Alerts Activated
                        </div>
                        <!-- Offer cards dynamically added here -->
                    </div>
                </section>

                <!-- Player Portfolio Section -->
                <section id="portfolio-section">
                    <h2 class="section-title">Your Portfolio</h2>
                    <div id="properties-area">
                        <!-- Property cards dynamically added here -->
                    </div>
                </section>

                <!-- Property Marketplace Section -->
                <section id="marketplace-section">
                    <h2>
                        Buy Properties <span class="subtitle">via RefiHub Owner-to-Owner Marketplace</span>
                        <span class="marketplace-refresh-inline">
                            <button id="refresh-marketplace-btn" class="btn-refresh">Refresh</button> 
                        </span>
                    </h2>
                    <div id="marketplace-area">
                         <!-- Marketplace cards dynamically added here -->
                     </div>
                </section>
            </div>

            <!-- Sidebar Area -->
            <aside id="sidebar-area">
                 <!-- Graphs -->
                <div id="rate-graph-widget" class="graph-widget">
                     <div class="graph-header"><h3>Interest Rate</h3><span id="current-market-rate" class="graph-current-value">-%</span></div>
                     <svg id="rate-graph" class="graph-svg" viewBox="0 0 200 100" preserveAspectRatio="none"><polyline id="rate-line" class="graph-line rate-line" points="0,50 200,50"/><text id="rate-max-label" x="5" y="10" class="axis-label">0%</text><text id="rate-min-label" x="5" y="95" class="axis-label">0%</text></svg>
                     <div class="graph-footer">Last 100 Days</div>
                 </div>
                 <div id="value-graph-widget" class="graph-widget">
                     <div class="graph-header"><h3>Value Index (YoY)</h3><span id="current-value-index" class="graph-current-value">N/A</span></div>
                     <svg id="value-graph" class="graph-svg" viewBox="0 0 200 100" preserveAspectRatio="none"><polyline id="value-line" class="graph-line value-line" points="0,50 200,50"/><text id="value-max-label" x="5" y="10" class="axis-label"></text><text id="value-min-label" x="5" y="95" class="axis-label"></text></svg>
                     <div class="graph-footer">Last 100 Days</div>
                 </div>
                  <div id="rent-graph-widget" class="graph-widget">
                     <div class="graph-header"><h3>Rent Index (YoY)</h3><span id="current-rent-index" class="graph-current-value">N/A</span></div>
                     <svg id="rent-graph" class="graph-svg" viewBox="0 0 200 100" preserveAspectRatio="none"><polyline id="rent-line" class="graph-line rent-line" points="0,50 200,50"/><text id="rent-max-label" x="5" y="10" class="axis-label"></text><text id="rent-min-label" x="5" y="95" class="axis-label"></text></svg>
                     <div class="graph-footer">Last 100 Days</div>
                 </div>
                 <div id="networth-graph-widget" class="graph-widget">
                     <div class="graph-header"><h3>Net Worth</h3><span id="current-networth-value" class="graph-current-value">$0</span></div>
                     <svg id="networth-graph" class="graph-svg" viewBox="0 0 200 100" preserveAspectRatio="none"><polyline id="networth-line" class="graph-line networth-line" points="0,50 200,50"/><text id="networth-max-label" x="5" y="10" class="axis-label"></text><text id="networth-min-label" x="5" y="95" class="axis-label"></text></svg>
                     <div class="graph-footer" id="networth-graph-footer">All Time</div>
                 </div>
                 <div id="cashflow-graph-widget" class="graph-widget">
                     <div class="graph-header"><h3>Cash Flow (Yearly)</h3><span id="current-cashflow-value" class="graph-current-value">$0</span></div>
                     <svg id="cashflow-graph" class="graph-svg" viewBox="0 0 200 100" preserveAspectRatio="none"><polyline id="cashflow-line" class="graph-line cashflow-line" points="0,50 200,50"/><text id="cashflow-max-label" x="5" y="10" class="axis-label"></text><text id="cashflow-min-label" x="5" y="95" class="axis-label"></text></svg>
                     <div class="graph-footer" id="cashflow-graph-footer">All Time</div>
                 </div>

                <!-- Message Log -->
                <div id="message-log-container">
                    <h2>Event Log</h2>
                    <div id="message-log"></div>
                </div>
            </aside>
        </div>

    </div> <!-- End #game-container -->

    <!-- Game Over / Win Overlay -->
    <div id="game-over-overlay">
        <h2 id="game-over-title">GAME OVER</h2>
        <p id="game-over-message">You went bankrupt!</p>
        <p>It took you <span id="final-days"></span> Days</p>
        <p>Final Net Worth: <span id="final-net-worth"></span></p>
        <button id="restart-btn" class="btn-primary">Restart Game</button>
    </div>

    <script>
        // --- Game Configuration Constants ---
        const STARTING_CASH = 150000;
        const BANKRUPTCY_THRESHOLD = -50000;
        const MAX_PROPERTIES = 9;
        const BASE_MARKET_RATE = 5.0;
        const MIN_RATE = 2.0;
        const MAX_RATE = 9.0;
        const CENTER_RATE = 4.5;
        const MEAN_REVERSION_FACTOR = 0.005;
        const DAILY_RATE_VOLATILITY = 0.02;
        const MAX_DAILY_RATE_CHANGE = 0.10;
        const CRASH_CHANCE_PER_DAY = 2 / 365;
        const CRASH_MAGNITUDE = 1.0;
        const CRASH_DURATION_DAYS = 7;
        const ANNUAL_VALUE_GROWTH_TARGET = 0.08; // Increased from 0.05
        const DAILY_VALUE_VOLATILITY = 0.002;
        const ANNUAL_RENT_GROWTH_TARGET = 0.07; // Increased from 0.04
        const DAILY_RENT_VOLATILITY = 0.0015;
        const UNSOLICITED_OFFER_CHANCE_PER_DAY = 0.01;
        const REFI_RATE_SPREAD = 0.5;
        const REFI_CLOSING_COST_PERCENT = 0.015; // Closing costs % of *loan amount*
        const PURCHASE_DOWN_PAYMENT_PERCENT = 0.25; // Standard assumption for purchase affordability
        const MAX_LTV_PURCHASE = 1.0 - PURCHASE_DOWN_PAYMENT_PERCENT; // Max LTV derived from DP%
        const PURCHASE_DSCR_THRESHOLD = 1.25;
        const CASH_OUT_RATE_PREMIUM = 0.15;
        const PURCHASE_RATE_PREMIUM = 0.25;
        const PURCHASE_LOAN_TERM_MONTHS = 360;
        const REFI_LOAN_TERM_MONTHS = 360;
        const TARGET_DSCR = 1.25;
        const SELLING_COST_PERCENT = 0.05;
        const GRAPH_HISTORY_LENGTH = 370;
        const GRAPH_DISPLAY_DAYS = 100;
        const GRAPH_UPDATE_INTERVAL = 3;
        const PROPERTY_TYPES = { APT: '🏢', PLEX: '🏘️', RETAIL: '🏬', OFFICE: '🏦', IND: '🏭' };
        const PROPERTY_TYPE_DETAILS = { APT: { baseCap: 0.06, name: 'Apartment Complex' }, PLEX: { baseCap: 0.065, name: 'Multi-Plex Housing' }, RETAIL: { baseCap: 0.07, name: 'Retail Strip' }, OFFICE: { baseCap: 0.075, name: 'Office Building' }, IND: { baseCap: 0.08, name: 'Industrial Warehouse' } };
        const MARKETPLACE_SIZE = 3;
        const MIN_MARKETPLACE_PRICE = 50000; // Minimum price for any generated property
        // const CASH_TO_PRICE_MULTIPLIER = 4; // Less relevant now with affordability logic
        const GAME_SPEED_MS = 1000;
        const LEVEL_MILESTONES = [ { threshold: 100000, name: "Getting Started", icon: "💰" }, { threshold: 250000, name: "Investor", icon: "🚗" }, { threshold: 500000, name: "Pro Investor", icon: "🏠" }, { threshold: 1000000, name: "Tycoon", icon: "🛥️" }, { threshold: 5000000, name: "Mogul", icon: "✈️" }, { threshold: 10000000, name: "Legend", icon: "🏆" } ];
        const REFI_RATE_IMPROVEMENT_THRESHOLD = 0.10;

        // --- Game State Variables ---
        let gameState = {};
        let gameLoopInterval = null;
        let rateHistory = []; let valueHistory = []; let rentHistory = []; let netWorthHistory = []; let cashFlowHistory = [];
        let tickCounter = 0; let lastMonthNetCashFlow = 0; let currentSimDate = new Date();
        let isCrashing = false; let crashTargetRate = 0; let crashDaysRemaining = 0;
        let nextPropertyId = 2000;

        // --- DOM References --- (Assume they are correctly fetched as before)
        // Header
        const timeDisplay = document.getElementById('time-display'); const propCountDisplay = document.getElementById('prop-count-display'); const netWorthDisplay = document.getElementById('net-worth-display'); const cashDisplay = document.getElementById('cash-display'); const totalLoanDisplay = document.getElementById('total-loan-display'); const totalDebtServiceDisplay = document.getElementById('total-debt-service-display'); const portfolioDscrDisplay = document.getElementById('portfolio-dscr-display'); const totalAumDisplay = document.getElementById('total-aum-display'); const avgRateDisplay = document.getElementById('avg-rate-display'); const totalNoiDisplay = document.getElementById('total-noi-display'); const lastCashflowDisplay = document.getElementById('last-cashflow-display'); const hdrMarketRateDisplay = document.getElementById('hdr-market-rate'); const levelIconEl = document.getElementById('level-icon'); const levelTextEl = document.getElementById('level-text'); const goalProgressEl = document.getElementById('goal-progress');
        // Content
        const propertiesArea = document.getElementById('properties-area'); const marketplaceArea = document.getElementById('marketplace-area'); const refreshMarketplaceBtn = document.getElementById('refresh-marketplace-btn'); const offersList = document.getElementById('offers-list'); const noOffersMessage = document.getElementById('no-offers-message');
        const lowerRateOffersBtn = document.getElementById('lower-rate-offers-toggle'); // Changed from toggle checkbox
        const cashOutOffersBtn = document.getElementById('cash-out-offers-toggle');   // Changed from toggle checkbox
        // Sidebar
        const messageLog = document.getElementById('message-log');
        // Graphs
        const rateLine = document.getElementById('rate-line'); const valueLine = document.getElementById('value-line'); const rentLine = document.getElementById('rent-line'); const networthLine = document.getElementById('networth-line'); const cashflowLine = document.getElementById('cashflow-line'); const rateMaxLabel = document.getElementById('rate-max-label'); const rateMinLabel = document.getElementById('rate-min-label'); const valueMaxLabel = document.getElementById('value-max-label'); const valueMinLabel = document.getElementById('value-min-label'); const rentMaxLabel = document.getElementById('rent-max-label'); const rentMinLabel = document.getElementById('rent-min-label'); const networthMaxLabel = document.getElementById('networth-max-label'); const networthMinLabel = document.getElementById('networth-min-label'); const cashflowMaxLabel = document.getElementById('cashflow-max-label'); const cashflowMinLabel = document.getElementById('cashflow-min-label'); const currentMarketRateEl = document.getElementById('current-market-rate'); const currentValueIndexEl = document.getElementById('current-value-index'); const currentRentIndexEl = document.getElementById('current-rent-index'); const currentNetworthValueEl = document.getElementById('current-networth-value'); const currentCashflowValueEl = document.getElementById('current-cashflow-value'); const networthGraphFooter = document.getElementById('networth-graph-footer'); const cashflowGraphFooter = document.getElementById('cashflow-graph-footer');
        // Game Over
        const gameOverOverlay = document.getElementById('game-over-overlay'); const gameOverTitle = document.getElementById('game-over-title'); const gameOverMessage = document.getElementById('game-over-message'); const finalDays = document.getElementById('final-days'); const finalNetWorth = document.getElementById('final-net-worth'); const restartBtn = document.getElementById('restart-btn');

        // --- Utility Functions --- (Unchanged)
        function formatCurrency(v, s=false, c=false){const n=Number(v);if(isNaN(n))return'$NaN';if(c&&Math.abs(n)>=1e3){const f=["","K","M","B","T"];let x=0,d=n;while(Math.abs(d)>=1e3&&x<f.length-1){d/=1e3;x++}const p=Math.abs(d)>=100?0:Math.abs(d)>=10?1:1;const g=n<0?"-":(s?"+":"");return`${g}$${Math.abs(d).toFixed(p)}${f[x]}`}const o={style:'currency',currency:'USD',minimumFractionDigits:0,maximumFractionDigits:0};if(s){o.signDisplay='always'}return n.toLocaleString('en-US',o)}
        function formatPercent(v, s=false){const n=Number(v);if(isNaN(n))return'NaN%';const o={style:'percent',minimumFractionDigits:1,maximumFractionDigits:1};if(s){o.signDisplay='always'}return(n/100).toLocaleString('en-US',o)}
        function formatPercentRate(v){const n=Number(v);return isNaN(n)?'NaN%':n.toFixed(2)+'%'}
        function formatDecimal(v, p=2){const n=Number(v);return isNaN(n)?'NaN':n.toFixed(p)}
        function formatFullDate(d){if(!(d instanceof Date))return"Invalid Date";return d.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}
        function calculateMonthlyPayment(p,r,t){p=Number(p);r=Number(r);t=Number(t);if(p<=0||t<=0||isNaN(p)||isNaN(r)||isNaN(t))return 0;if(r===0)return p/t;const m=r/100/12;const n=t;const y=p*(m*Math.pow(1+m,n))/(Math.pow(1+m,n)-1);return(isNaN(y)||!isFinite(y))?0:y}
        function calculateAnnualDebtService(p,r,t){return calculateMonthlyPayment(p,r,t)*12}
        function calculateMaxLoanByDSCR(a,r,t,d){a=Number(a);r=Number(r);t=Number(t);d=Number(d);if(a<=0||r<0||t<=0||d<=0||isNaN(a)||isNaN(r)||isNaN(t)||isNaN(d))return 0;const s=a/d;const m=s/12;if(m<=0)return 0;if(r===0)return m*t;const o=r/100/12;const n=t;const p=m*(1-Math.pow(1+o,-n))/o;return(isNaN(p)||!isFinite(p)||p<0)?0:p}
        function logMessage(m,y='info'){if(!messageLog){console.error("Log element missing!");return}const d=gameState&&gameState.day>0?`D${gameState.day}: `:'Init: ';const p=document.createElement('p');p.textContent=d+m;p.className=`log-${y}`;messageLog.appendChild(p);messageLog.scrollTop=messageLog.scrollHeight;while(messageLog.children.length>100){messageLog.removeChild(messageLog.firstChild)}}
        function highlightStatus(e){const l=document.getElementById(e)?.parentElement;if(l){l.classList.add('highlight');setTimeout(()=>{l.classList.remove('highlight')},600)}}

        // --- Core Calculation Functions --- (Verified)
        function calculateTotalAUM(){if(!gameState||!gameState.properties)return 0;const p=gameState.properties.reduce((s,x)=>s+(Number(x.value)||0),0);const c=Number(gameState.cash)||0;return p+c}
        function calculateTotalLoanBalance(){if(!gameState||!gameState.properties)return 0;return gameState.properties.reduce((s,p)=>s+(Number(p.loan?.balance)||0),0)}
        function calculateNetWorth(){return calculateTotalAUM()-calculateTotalLoanBalance()}
        function calculateAverageLoanRate(){if(!gameState||!gameState.properties||gameState.properties.length===0)return 0;let b=0,w=0;gameState.properties.forEach(p=>{const l=Number(p.loan?.balance)||0;const r=Number(p.loan?.rate)||0;if(l>0){b+=l;w+=l*r}});return b>0?(w/b):0}
        function calculateTotalYearlyDebtService(){if(!gameState||!gameState.properties)return 0;return gameState.properties.reduce((s,p)=>{const b=Number(p.loan?.balance)||0;const r=Number(p.loan?.rate)||0;const m=Number(p.loan?.monthsRemaining)||0;const a=(b>0&&m>0)?calculateAnnualDebtService(b,r,m):0;return s+a},0)}
        function calculatePortfolioDSCR(){if(!gameState||!gameState.properties||gameState.properties.length===0)return Infinity;const n=gameState.properties.reduce((s,p)=>s+(Number(p.noi)||0),0)*12;const d=calculateTotalYearlyDebtService();if(n<=0&&d<=0)return Infinity;if(d<=0)return Infinity;if(n<=0)return 0;return n/d}

        // --- Graph Update Function --- (Handles All-Time/100-Day)
        function updateGraphs() { try { const w = 200, h = 100; const updateSingle = (line, maxL, minL, hist, currEl, footEl, fmtFn, yFmtFn = formatDecimal, sign = false, compact = false, allTime = false) => { if (!line || !hist) return; const fullHist = hist.filter(v => typeof v === 'number' && isFinite(v)); const dispHist = allTime ? fullHist : fullHist.slice(-GRAPH_DISPLAY_DAYS); const len = dispHist.length; if (len < 2) { line.setAttribute('points', `0,${h / 2} ${w},${h / 2}`); if(maxL) maxL.textContent = ''; if(minL) minL.textContent = ''; if(currEl){const last=hist[hist.length-1]; currEl.textContent=(typeof last==='number'&&isFinite(last))?fmtFn(last,sign,compact):'N/A';currEl.className='graph-current-value'} if(footEl) footEl.textContent = allTime ? 'All Time' : `Last ${len} Days`; return; } const curr = dispHist[len - 1]; const prev = len > 1 ? dispHist[len - 2] : curr; 

 // --- New Scaling Logic --- 
 let minH = Math.min(...dispHist);
 let maxH = Math.max(...dispHist);
 let dataRange = maxH - minH;

 // Determine the display range: Use data range + buffer, ensure minimum range
 let dispRange = Math.max(dataRange * 1.2, Math.abs(curr * 0.02), 0.1); // Add 20% buffer, min 2% of current value, or 0.1 absolute

 // Calculate scale min/max centered around the current value
 let minS = curr - dispRange / 2;
 let maxS = curr + dispRange / 2;

 // Optional: Add floor/ceiling constraints if needed (e.g., for rates/indices)
 if (line.id === 'rate-line') {
   minS = Math.max(MIN_RATE * 0.9, minS); // Allow slight dip below min rate for centering
   maxS = Math.min(MAX_RATE * 1.1, maxS);
 } else if (line.id === 'value-line' || line.id === 'rent-line') {
    minS = Math.max(0.1, minS); // Ensure indices don't scale below 0.1
 }
 // Ensure range is still valid after constraints
 dispRange = Math.max(0.1, maxS - minS);
 // --- End New Scaling Logic ---

 const pts = dispHist.map((v, i) => { const x = len > 1 ? (i / (len - 1)) * w : w / 2; const yValue = ((v - minS) / dispRange); const y = h - yValue * h; // Calculate y-coordinate based on the new scale
 const cy = Math.max(0.1, Math.min(h - 0.1, y)); // Clamp y-coordinate within view box
 if (isNaN(x) || isNaN(cy)) return null; return `${x.toFixed(1)},${cy.toFixed(1)}`; }).filter(p => p !== null).join(' '); 

 if (pts && pts.length > 0 && pts.includes(',')) { line.setAttribute('points', pts); } else { line.setAttribute('points', `0,${h / 2} ${w},${h / 2}`); } 

 if (maxL) maxL.textContent = yFmtFn(maxS, false, true);
 if (minL) minL.textContent = yFmtFn(minS, false, true); 

 if (currEl) { currEl.textContent = fmtFn(curr, sign, compact); let trend = ''; if (curr > prev + 1e-6) trend = 'positive'; else if (curr < prev - 1e-6) trend = 'negative'; currEl.className = `graph-current-value ${trend}`; } 

 if(footEl) footEl.textContent = allTime ? 'All Time' : `Last ${len} Days`; 

 }; const fmtYoY = (hist) => { if (!hist || hist.length < GRAPH_HISTORY_LENGTH) { const start = hist?.[0] ?? 1; const current = hist?.[hist.length - 1] ?? start; if (typeof current !== 'number' || typeof start !== 'number' || !isFinite(current) || !isFinite(start) || start <= 0) return { text: "+0.0%", class: "" }; const change = ((current / start) - 1) * 100; const cls = change > 0.01 ? 'positive' : change < -0.01 ? 'negative' : ''; return { text: formatPercent(change, true), class: cls }; } const current = hist[hist.length - 1]; const past = hist[hist.length - 1 - 365]; if (typeof current !== 'number' || typeof past !== 'number' || !isFinite(current) || !isFinite(past) || past <= 0) return { text: "N/A", class: "" }; const change = ((current / past) - 1) * 100; const cls = change > 0.01 ? 'positive' : change < -0.01 ? 'negative' : ''; return { text: formatPercent(change, true), class: cls }; }; /* Update calls */ updateSingle(rateLine, rateMaxLabel, rateMinLabel, rateHistory, currentMarketRateEl, document.querySelector('#rate-graph-widget .graph-footer'), formatPercentRate, formatPercentRate, false, false, false); const yoyV = fmtYoY(valueHistory); updateSingle(valueLine, valueMaxLabel, valueMinLabel, valueHistory, currentValueIndexEl, document.querySelector('#value-graph-widget .graph-footer'), () => yoyV.text, formatDecimal, false, false, false); if(currentValueIndexEl) currentValueIndexEl.className = `graph-current-value ${yoyV.class}`; const yoyR = fmtYoY(rentHistory); updateSingle(rentLine, rentMaxLabel, rentMinLabel, rentHistory, currentRentIndexEl, document.querySelector('#rent-graph-widget .graph-footer'), () => yoyR.text, formatDecimal, false, false, false); if(currentRentIndexEl) currentRentIndexEl.className = `graph-current-value ${yoyR.class}`; updateSingle(networthLine, networthMaxLabel, networthMinLabel, netWorthHistory, currentNetworthValueEl, networthGraphFooter, formatCurrency, formatCurrency, false, true, true); updateSingle(cashflowLine, cashflowMaxLabel, cashflowMinLabel, cashFlowHistory, currentCashflowValueEl, cashflowGraphFooter, formatCurrency, formatCurrency, true, true, true); } catch (e) { console.error("Graph update error:", e); logMessage("Graph error.", "error"); } }

        // --- Game Logic Functions ---
        function generateMarketplaceProperty(targetPrice) { /* (Unchanged) */ nextPropertyId++; const k=Object.keys(PROPERTY_TYPES);const r=k[Math.floor(Math.random()*k.length)];const d=PROPERTY_TYPE_DETAILS[r];const p=Math.max(MIN_MARKETPLACE_PRICE, Math.round(targetPrice*(0.85+Math.random()*0.3)));const c=d.baseCap*(0.9+Math.random()*0.2);const a=p*c;const m=Math.round(a/12);const n=["Metro","Central","Riverside","Uptown","Suburban","Gateway","Landmark","Apex","Summit"];const x=`${n[Math.floor(Math.random()*n.length)]} ${d.name}`;return{id:nextPropertyId,name:x,type:PROPERTY_TYPES[r],price:p,noi:m}; }

        /** Refreshes marketplace, ensuring at least one affordable property. */
        function refreshMarketplace() {
            logMessage("Refreshing marketplace listings...", "action");
            gameState.marketplaceProperties = [];
            let affordableGenerated = false;

            // Calculate max price player can roughly afford with 25% down + closing costs buffer
            const cashForDownPaymentAndCosts = gameState.cash * 0.9; // Use 90% cash for safety buffer
            const maxAffordablePrice = Math.floor(cashForDownPaymentAndCosts / (PURCHASE_DOWN_PAYMENT_PERCENT + REFI_CLOSING_COST_PERCENT * MAX_LTV_PURCHASE));

            for (let i = 0; i < MARKETPLACE_SIZE; i++) {
                let targetPrice;
                // Ensure at least one property is targeted to be affordable if none generated yet
                if (i === MARKETPLACE_SIZE - 1 && !affordableGenerated) {
                    targetPrice = Math.max(MIN_MARKETPLACE_PRICE, maxAffordablePrice * (0.8 + Math.random() * 0.25)); // Target near affordable max
                    logMessage(`Generating specifically affordable property (Target: ~${formatCurrency(targetPrice)})`, "info");
                } else {
                     // Generate properties with wider variance, sometimes affordable, sometimes aspirational
                    const affordabilityFactor = Math.random(); // 0 to 1
                    if (affordabilityFactor < 0.5) { // 50% chance: Target affordable range
                        targetPrice = Math.max(MIN_MARKETPLACE_PRICE, maxAffordablePrice * (0.7 + Math.random() * 0.5)); // Wider range within affordable
                    } else { // 50% chance: Target higher (aspirational)
                         const currentAUM = calculateTotalAUM();
                         const aspirationalBase = Math.max(maxAffordablePrice, (gameState.cash + currentAUM * 0.1) * 1.5); // Aim higher than current AUM might suggest
                         targetPrice = Math.max(MIN_MARKETPLACE_PRICE, aspirationalBase * (0.8 + Math.random() * 0.7));
                    }
                }

                const newProp = generateMarketplaceProperty(targetPrice);
                gameState.marketplaceProperties.push(newProp);

                // Quick check if this generated property *might* be affordable (rough check)
                if (newProp.price <= maxAffordablePrice * 1.05) { // Allow 5% wiggle room
                     affordableGenerated = true;
                }
            }
            updateUI();
        }

        function initGame() { /* (Logic unchanged, calls new refreshMarketplace) */
             console.log("Initializing game..."); if (gameLoopInterval) clearInterval(gameLoopInterval);
             try { currentSimDate = new Date(); currentSimDate.setHours(0,0,0,0);
             gameState={day:0,simDate:new Date(currentSimDate),cash:STARTING_CASH,marketRate:BASE_MARKET_RATE,propertyValueMultiplier:1.0,rentIndexMultiplier:1.0,isPaused:false,playerLevel:0,receiveLowerRateOffers:true,receiveCashOutOffers:true,
             properties:[{id:1,name:"Downtown Apt",type:PROPERTY_TYPES.APT,baseValue:500000,value:500000,baseNoi:3300,noi:3300,loan:{id:101,initialBalance:375000,balance:375000,rate:5.5,termMonths:360,monthsRemaining:360}},{id:2,name:"Suburban Plex",type:PROPERTY_TYPES.PLEX,baseValue:750000,value:750000,baseNoi:5225,noi:5225,loan:{id:102,initialBalance:562500,balance:562500,rate:6.0,termMonths:360,monthsRemaining:360}},{id:3,name:"Small Retail",type:PROPERTY_TYPES.RETAIL,baseValue:400000,value:400000,baseNoi:2860,noi:2860,loan:{id:103,initialBalance:280000,balance:280000,rate:5.0,termMonths:240,monthsRemaining:240}}],
             marketplaceProperties:[],offers:[],gameOver:false,gameWon:false};
             rateHistory=[gameState.marketRate];valueHistory=[gameState.propertyValueMultiplier];rentHistory=[gameState.rentIndexMultiplier];netWorthHistory=[calculateNetWorth()];cashFlowHistory=[0];
             refreshMarketplace(); // Calls the new logic
             tickCounter=0;lastMonthNetCashFlow=0;isCrashing=false;crashDaysRemaining=0;nextPropertyId=2000;
             if(gameOverOverlay)gameOverOverlay.style.display='none';if(messageLog)messageLog.innerHTML='';
             // Initialize toggle button states
             if(lowerRateOffersBtn) lowerRateOffersBtn.classList.toggle('active', gameState.receiveLowerRateOffers);
             if(cashOutOffersBtn) cashOutOffersBtn.classList.toggle('active', gameState.receiveCashOutOffers);
             if(noOffersMessage)noOffersMessage.style.display='block';
             logMessage("RefiHub: Real-Time Simulation START!","success");logMessage(`Starting Cash: ${formatCurrency(gameState.cash)}`,"info");logMessage(`Initial Portfolio DSCR: ${formatDecimal(calculatePortfolioDSCR(),2)}`,"info");logMessage(`Goal: Reach ${formatCurrency(LEVEL_MILESTONES[LEVEL_MILESTONES.length-1].threshold,false,true)}/yr Cash Flow!`,"info");
             updateUI();updateGraphs();startGameLoop();console.log("Game initialized.");}catch(e){console.error("Init Error:",e);logMessage(`FATAL ERROR init: ${e.message}. Cannot start.`,"error");if(gameLoopInterval)clearInterval(gameLoopInterval);gameLoopInterval=null;}
        }
        function startGameLoop() { if (gameLoopInterval || gameState.gameOver) return; gameState.isPaused = false; console.log("Starting loop..."); gameLoopInterval = setInterval(() => gameTick(), GAME_SPEED_MS); if (gameState.day > 0) logMessage("Game Resumed.", "info"); updateUI(); }
        function pauseGameLoopOnError() { if (gameLoopInterval) { console.log("Pausing loop (Error)."); clearInterval(gameLoopInterval); gameLoopInterval = null; gameState.isPaused = true; logMessage("Game Paused (Error).", "error"); updateUI(); } }
        function updateMarketDaily() { /* (Unchanged) */ let r=0,n=gameState.marketRate;if(isCrashing&&crashDaysRemaining>0){const t=(crashTargetRate-gameState.marketRate)/Math.max(1,crashDaysRemaining);r=t;crashDaysRemaining--;if(crashDaysRemaining<=0){isCrashing=false;logMessage("Rate crash finished.","info")}}else if(!isCrashing&&Math.random()<CRASH_CHANCE_PER_DAY){isCrashing=true;crashTargetRate=Math.max(MIN_RATE,gameState.marketRate-CRASH_MAGNITUDE);crashDaysRemaining=CRASH_DURATION_DAYS;r=(crashTargetRate-gameState.marketRate)/Math.max(1,crashDaysRemaining);logMessage(`Rate crash! Target: ${formatPercentRate(crashTargetRate)} over ${CRASH_DURATION_DAYS} days.`,"warning")}else{isCrashing=false;const f=(Math.random()*2-1)*DAILY_RATE_VOLATILITY;const v=(CENTER_RATE-gameState.marketRate)*MEAN_REVERSION_FACTOR;r=f+v;r=Math.max(-MAX_DAILY_RATE_CHANGE,Math.min(MAX_DAILY_RATE_CHANGE,r))}n=gameState.marketRate+r;gameState.marketRate=Math.max(MIN_RATE,Math.min(MAX_RATE,n));const dV=Math.pow(1+ANNUAL_VALUE_GROWTH_TARGET,1/365)-1;const vV=(Math.random()*2-1)*DAILY_VALUE_VOLATILITY;const vC=dV+vV;gameState.propertyValueMultiplier=Math.max(0.5,gameState.propertyValueMultiplier*(1+vC));const dR=Math.pow(1+ANNUAL_RENT_GROWTH_TARGET,1/365)-1;const rV=(Math.random()*2-1)*DAILY_RENT_VOLATILITY;const rC=dR+rV;gameState.rentIndexMultiplier=Math.max(0.5,gameState.rentIndexMultiplier*(1+rC));gameState.properties.forEach(p=>{p.value=p.baseValue*gameState.propertyValueMultiplier;p.noi=p.baseNoi*gameState.rentIndexMultiplier}); }
        function processMonthlyEvents() { /* (Unchanged) */ let n=0,p=0,f=false;gameState.properties.forEach(x=>{if(!x.loan||x.loan.balance<=0)return;n+=(Number(x.noi)||0);const t=Math.max(1,x.loan.monthsRemaining);const m=calculateMonthlyPayment(x.loan.balance,x.loan.rate,t);p+=m;const i=x.loan.balance*(x.loan.rate/100)/12;const c=Math.max(0,m-i);x.loan.balance-=c;if(x.loan.balance<=0.01){x.loan.balance=0;x.loan.monthsRemaining=0;logMessage(`${x.name} Loan PAID OFF!`,"success");f=true}});lastMonthNetCashFlow=n-p;const b=gameState.cash;gameState.cash+=lastMonthNetCashFlow;logMessage(`End of Month ${gameState.simDate.toLocaleString('default',{month:'short'})}: Income: ${formatCurrency(n)}, Pmt: ${formatCurrency(p)}, Net CF: ${formatCurrency(lastMonthNetCashFlow,true)}. Cash ${formatCurrency(b)} -> ${formatCurrency(gameState.cash)}`,"info");highlightStatus('cash-display');highlightStatus('last-cashflow-display');if(f){updateUI()} }

        // --- Offer Generation Functions --- (Non-pausing)
        function generateUnsolicitedOffers() { /* (Generates non-pausing offers) */ if(gameState.gameOver||!gameState.properties||gameState.properties.length===0)return;gameState.properties.forEach(p=>{if(!p||!p.loan||p.loan.balance<=0||p.loan.monthsRemaining<=0||gameState.offers.some(o=>o.propertyId===p.id))return;if(Math.random()<UNSOLICITED_OFFER_CHANCE_PER_DAY){let r=Math.max(MIN_RATE,gameState.marketRate-REFI_RATE_SPREAD+(Math.random()*0.4-0.2));const a=(Number(p.noi)||0)*12;if(a<=0)return;const d=calculateMaxLoanByDSCR(a,r,REFI_LOAN_TERM_MONTHS,TARGET_DSCR);let o=Math.max(0,d);let n=Math.max(p.loan.balance*0.95,o);n=Math.min(n,d);let c=Math.max(0,n-p.loan.balance);const s=c>1000;const i=r<p.loan.rate-REFI_RATE_IMPROVEMENT_THRESHOLD;if(s&&!i){r=Math.max(MIN_RATE,r+CASH_OUT_RATE_PREMIUM);const dC=calculateMaxLoanByDSCR(a,r,REFI_LOAN_TERM_MONTHS,TARGET_DSCR);o=Math.max(0,dC);n=Math.max(p.loan.balance*0.95,o);n=Math.min(n,dC);c=Math.max(0,n-p.loan.balance)}const lT=r<p.loan.rate-REFI_RATE_IMPROVEMENT_THRESHOLD;const cT=c>1000;let g=false;if(lT&&gameState.receiveLowerRateOffers)g=true;if(cT&&gameState.receiveCashOutOffers)g=true;if(!lT&&!cT&&(gameState.receiveLowerRateOffers||gameState.receiveCashOutOffers)){g=true}if(r>p.loan.rate+0.5&&c<p.loan.balance*0.1){g=false}if(g&&n>0){generateAndAddOffer(p,r,true,'Refinance',n,c,p.noi)}}}); }
        function generateAndAddOffer(p,r,u=false,t='Refinance',n=p.loan.balance,o=0,m){if(gameState.offers.some(f=>f.propertyId===p.id))return;n=Number(n)||0;r=Number(r)||0;m=Number(m)||0;o=Number(o)||0;if(n<=0||r<0){logMessage(`Could not generate valid ${t} for ${p.name} (invalid loan/rate).`,"warning");return}const c=n*REFI_CLOSING_COST_PERCENT;const e=REFI_LOAN_TERM_MONTHS;const y=calculateMonthlyPayment(n,r,e);const s=y*12;const a=m*12;let w=Infinity;if(s>0){w=a>0?(a/s):0}else if(a<=0&&s<=0){w=Infinity}else if(a>0&&s<=0){w=Infinity}const g=(p.loan&&p.loan.balance>0&&p.loan.monthsRemaining>0)?calculateMonthlyPayment(p.loan.balance,p.loan.rate,p.loan.monthsRemaining):0;const f={offerId:Date.now()+p.id+Math.random(),type:t,propertyId:p.id,propertyName:p.name,loanId:p.loan?.id||null,currentRate:p.loan?.rate||0,currentPayment:g,monthlyNOI:m,newRate:parseFloat(r.toFixed(2)),newTerm:e,closingCosts:Math.round(c),newLoanAmount:Math.round(n),cashOutAmount:Math.round(o),newPotentialPayment:y,newDSCR:w,source:u?'Lender Offer':'Your Quote',pausesGame:false};gameState.offers.push(f);logMessage(`Refi ${u?'Offer':'Quote'} for ${p.name}: ${formatPercentRate(f.newRate)} rate, Loan: ${formatCurrency(f.newLoanAmount)} ${f.cashOutAmount>0?'(Cash Out: '+formatCurrency(f.cashOutAmount)+')':''} (New DSCR: ${isFinite(f.newDSCR)?formatDecimal(f.newDSCR,2):'N/A'})`,"offer");updateUI();}

        // --- Player Action Functions --- (Unchanged logic, but non-pausing)
        function requestRefinance(id){const p=gameState.properties.find(x=>x.id===id);if(!p){logMessage(`Error: Prop ID ${id} not found.`,"warning");return}if(!p.loan||p.loan.balance<=0){logMessage(`${p.name} loan paid off.`,"info");return}if(gameState.offers.some(o=>o.propertyId===p.id)){logMessage(`Offer exists for ${p.name}.`,"info");return}logMessage(`Requesting refi quote for ${p.name}...`,"action");let r=Math.max(MIN_RATE,gameState.marketRate-REFI_RATE_SPREAD*0.75+(Math.random()*0.2-0.1));const a=(Number(p.noi)||0)*12;if(a<=0){logMessage(`Cannot quote ${p.name}: No positive NOI.`,"warning");return}const d=calculateMaxLoanByDSCR(a,r,REFI_LOAN_TERM_MONTHS,TARGET_DSCR);let l=Math.max(0,d);let n=Math.max(p.loan.balance,l);n=Math.min(n,d);let c=Math.max(0,n-p.loan.balance);if(c>1000){r=Math.max(MIN_RATE,r+CASH_OUT_RATE_PREMIUM);const dC=calculateMaxLoanByDSCR(a,r,REFI_LOAN_TERM_MONTHS,TARGET_DSCR);l=Math.max(0,dC);n=Math.max(p.loan.balance,l);n=Math.min(n,dC);c=Math.max(0,n-p.loan.balance)}if(n>0&&n>=p.loan.balance*0.9){generateAndAddOffer(p,r,false,'Refinance Quote',n,c,p.noi)}else{logMessage(`Could not generate favorable quote for ${p.name} (Loan: ${formatCurrency(n)}, Rate: ${formatPercentRate(r)}).`,"warning");}}
        function attemptPurchase(id){if(gameState.properties.length>=MAX_PROPERTIES){logMessage(`Portfolio full (${MAX_PROPERTIES}/${MAX_PROPERTIES}). Sell first.`,"warning");return}const idx=gameState.marketplaceProperties.findIndex(p=>p.id===id);if(idx===-1){logMessage("Prop not in marketplace.","warning");return}const prop=gameState.marketplaceProperties[idx];const price=prop.price;logMessage(`Attempting purchase of ${prop.name} for ${formatCurrency(price)}...`,"action");const annualNOI=(Number(prop.noi)||0)*12;if(annualNOI<=0){logMessage(`Purchase Failed: ${prop.name} no positive NOI.`,"warning");return}const rate=Math.max(MIN_RATE,gameState.marketRate+PURCHASE_RATE_PREMIUM+(Math.random()*0.1-0.05));const maxDSCR=calculateMaxLoanByDSCR(annualNOI,rate,PURCHASE_LOAN_TERM_MONTHS,TARGET_DSCR);const maxLTV=price*MAX_LTV_PURCHASE;const loanAmt=Math.max(0,Math.min(maxDSCR,maxLTV));const downPmt=price-loanAmt;const costs=loanAmt*REFI_CLOSING_COST_PERCENT;const needed=downPmt+costs;logMessage(`Finance Check: Price=${formatCurrency(price)}, Rate=${formatPercentRate(rate)}, MaxLoan(DSCR):${formatCurrency(maxDSCR)}, MaxLoan(LTV):${formatCurrency(maxLTV)} -> Loan=${formatCurrency(loanAmt)}. DownReq=${formatCurrency(downPmt)}, Costs=${formatCurrency(costs)}, TotalNeed=${formatCurrency(needed)}`,"info");if(gameState.cash<needed){logMessage(`Purchase Failed: Need ${formatCurrency(needed)} cash (Have ${formatCurrency(gameState.cash)}).`,"warning");return}logMessage(`Financing OK! Purchase complete!`,"success");const newP={id:prop.id,name:prop.name,type:prop.type,baseValue:price,value:price,baseNoi:prop.noi,noi:prop.noi*gameState.rentIndexMultiplier,loan:{id:Date.now()+prop.id+Math.random(),initialBalance:loanAmt,balance:loanAmt,rate:parseFloat(rate.toFixed(2)),termMonths:PURCHASE_LOAN_TERM_MONTHS,monthsRemaining:PURCHASE_LOAN_TERM_MONTHS}};gameState.properties.push(newP);gameState.cash-=needed;highlightStatus('cash-display');gameState.marketplaceProperties.splice(idx,1);refreshMarketplace();/*Replaced immediately*/logMessage(`Purchased ${newP.name}! Cash: ${formatCurrency(gameState.cash)}`,"buy-sell");updateUI();}
        function sellProperty(id){const idx=gameState.properties.findIndex(p=>p.id===id);if(idx===-1){logMessage("Prop not found.","warning");return}const p=gameState.properties[idx];const val=p.value;const cost=val*SELLING_COST_PERCENT;const pay=Number(p.loan?.balance)||0;const proc=val-pay-cost;logMessage(`Selling ${p.name} for ${formatCurrency(val)}... Costs: ${formatCurrency(cost)}, Payoff: ${formatCurrency(pay)}`,"action");gameState.cash+=proc;highlightStatus('cash-display');gameState.properties.splice(idx,1);const initOffers=gameState.offers.length;gameState.offers=gameState.offers.filter(o=>o.propertyId!==id);if(gameState.offers.length<initOffers){logMessage(`Removed offer for sold ${p.name}.`,"info")}logMessage(`Sold ${p.name}! Proceeds: ${formatCurrency(proc)}. Cash: ${formatCurrency(gameState.cash)}`,"buy-sell");updateUI();}
        function acceptRefi(id){const idx=gameState.offers.findIndex(o=>o.offerId===id);if(idx===-1){logMessage("Offer not found.","warning");return}const offer=gameState.offers[idx];const prop=gameState.properties.find(p=>p.id===offer.propertyId);if(!prop){logMessage(`Prop for offer ${id} (${offer.propertyName}) not found. Offer removed.`,"warning");gameState.offers.splice(idx,1);updateUI();return}const netCash=offer.cashOutAmount-offer.closingCosts;if(gameState.cash+netCash<0){logMessage(`Cannot accept Refi: Need ${formatCurrency(-netCash)} cash for costs.`,"warning");return}gameState.cash+=netCash;if(!prop.loan){prop.loan={}}prop.loan.balance=offer.newLoanAmount;prop.loan.rate=offer.newRate;prop.loan.termMonths=offer.newTerm;prop.loan.monthsRemaining=offer.newTerm;prop.loan.initialBalance=offer.newLoanAmount;prop.loan.id=Date.now()+prop.id+Math.random();logMessage(`Refinanced ${prop.name}! Rate:${formatPercentRate(prop.loan.rate)}, Loan:${formatCurrency(prop.loan.balance)}. ${offer.cashOutAmount>0?'Cash Out:'+formatCurrency(offer.cashOutAmount)+'.':''} Costs:${formatCurrency(offer.closingCosts)}. NetCash:${formatCurrency(netCash,true)}`,"success");highlightStatus('cash-display');highlightStatus('avg-rate-display');highlightStatus('total-loan-display');highlightStatus('total-debt-service-display');highlightStatus('portfolio-dscr-display');gameState.offers.splice(idx,1);updateUI();}
        function rejectRefi(id){const idx=gameState.offers.findIndex(o=>o.offerId===id);if(idx===-1){logMessage("Offer not found.","warning");return}const offer=gameState.offers[idx];logMessage(`Rejected refi ${offer.source==='Lender Offer'?'offer':'quote'} for ${offer.propertyName}.`,"action");gameState.offers.splice(idx,1);updateUI();}

        // --- Offer Action Handlers --- (Non-pausing)
        function handleAcceptOffer(e){const b=e.target.closest('button.btn-accept');if(!b||b.disabled)return;const id=Number(b.dataset.offerId);if(isNaN(id))return;const o=gameState.offers.find(x=>x.offerId===id);if(!o)return;if(o.type==='Refinance'||o.type==='Refinance Quote'){acceptRefi(id)}}
        function handleRejectOffer(e){const b=e.target.closest('button.btn-reject');if(!b||b.disabled)return;const id=Number(b.dataset.offerId);if(isNaN(id))return;const o=gameState.offers.find(x=>x.offerId===id);if(!o)return;if(o.type==='Refinance'||o.type==='Refinance Quote'){rejectRefi(id)}}

        // --- End Conditions & Level Up --- (Unchanged)
        function checkEndConditions(){if(gameState.gameOver)return;const n=calculateNetWorth();if(n<BANKRUPTCY_THRESHOLD){gameState.gameOver=true;gameState.gameWon=false;gameOverTitle.textContent="BANKRUPTCY";gameOverTitle.className='lose';gameOverMessage.textContent=`Net worth (${formatCurrency(n)}) below threshold (${formatCurrency(BANKRUPTCY_THRESHOLD)})!`;logMessage("GAME OVER - Bankruptcy!","error");if(gameLoopInterval)clearInterval(gameLoopInterval);gameLoopInterval=null;finalDays.textContent=gameState.day;finalNetWorth.textContent=formatCurrency(n);if(gameOverOverlay)gameOverOverlay.style.display='flex'}}
        function checkLevelUp(){if(!gameState||gameState.gameOver)return;const y=lastMonthNetCashFlow*12;const c=gameState.playerLevel;let n=-1;for(let i=0;i<LEVEL_MILESTONES.length;i++){if(y>=LEVEL_MILESTONES[i].threshold){n=i}else{break}}if(n===-1)n=0;if(n>c){gameState.playerLevel=n;const l=LEVEL_MILESTONES[n];logMessage(`LEVEL UP! Reached ${l.name} status (${formatCurrency(l.threshold,false,true)}/yr CF)! ${l.icon}`,"success");highlightStatus('level-display');if(n===LEVEL_MILESTONES.length-1){gameState.gameOver=true;gameState.gameWon=true;if(gameLoopInterval)clearInterval(gameLoopInterval);gameLoopInterval=null;gameOverTitle.textContent="YOU WIN! 🏆";gameOverTitle.className='win';gameOverMessage.textContent=`Congrats! Legendary status with ${formatCurrency(y)}/yr cash flow!`;finalDays.textContent=gameState.day;finalNetWorth.textContent=formatCurrency(calculateNetWorth());if(gameOverOverlay)gameOverOverlay.style.display='flex';logMessage("CONGRATS! LEGENDARY STATUS!","success")}updateUI()}}

        // --- Main Game Tick Function --- (Non-pausing)
        function gameTick() { if (!gameState || gameState.gameOver || gameState.isPaused) { if(gameLoopInterval && (gameState.gameOver || gameState.isPaused)) { console.warn("Clearing stray interval."); clearInterval(gameLoopInterval); gameLoopInterval = null; } return; } try { gameState.day++; tickCounter++; const dt = new Date(gameState.simDate); dt.setDate(dt.getDate() + 1); gameState.simDate = dt; const dAvg = 365.25 / 12; gameState.properties.forEach(p => { if (p.loan && p.loan.monthsRemaining > 0) { p.loan.monthsRemaining -= (1 / dAvg); if (p.loan.monthsRemaining < 1e-6 && p.loan.balance > 0.01) { p.loan.monthsRemaining = Math.max(0, p.loan.monthsRemaining); } else if (p.loan.balance <= 0.01) { p.loan.monthsRemaining = 0; } } }); updateMarketDaily(); rateHistory.push(gameState.marketRate); valueHistory.push(gameState.propertyValueMultiplier); rentHistory.push(gameState.rentIndexMultiplier); netWorthHistory.push(calculateNetWorth()); cashFlowHistory.push(lastMonthNetCashFlow * 12); /* History trimming removed for NW/CF */ generateUnsolicitedOffers(); if (gameState.simDate.getDate() === 1 && gameState.day > 1) { processMonthlyEvents(); checkLevelUp(); if(cashFlowHistory.length > 0) cashFlowHistory[cashFlowHistory.length - 1] = lastMonthNetCashFlow * 12; } if (tickCounter % GRAPH_UPDATE_INTERVAL === 0) { updateGraphs(); } if (gameState.day % 5 === 0) { checkEndConditions(); } updateUI(); } catch (e) { console.error(`Tick Error (Day ${gameState?.day}):`, e); logMessage(`Runtime Error! ${e.message}. Game paused. See console.`, "error"); pauseGameLoopOnError(); } }

        // --- UI Update Function --- (Adds Cash Out Color)
        function updateUI() {
             if (!gameState || typeof gameState.cash === 'undefined' || !gameState.properties || !gameState.offers || !gameState.marketplaceProperties) { console.error("GameState incomplete."); return; }
             const currentNetWorth = calculateNetWorth(); const currentAvgRate = calculateAverageLoanRate(); const totalAnnualNOI = gameState.properties.reduce((s, p) => s + (Number(p.noi) || 0), 0) * 12; const totalLoanBal = calculateTotalLoanBalance(); const totalYearlyDebtSvc = calculateTotalYearlyDebtService(); const yearlyCashFlow = lastMonthNetCashFlow * 12; const portfolioDSCR = calculatePortfolioDSCR(); const totalAUM = calculateTotalAUM(); const isPausedByError = gameState.isPaused;

            // Update Header/Level (Same as v13.1)
             try { if(timeDisplay) timeDisplay.textContent=formatFullDate(gameState.simDate); if(propCountDisplay) propCountDisplay.textContent=`${gameState.properties.length} / ${MAX_PROPERTIES}`; if(totalAumDisplay) totalAumDisplay.textContent=formatCurrency(totalAUM,false,true); if(netWorthDisplay){netWorthDisplay.textContent=formatCurrency(currentNetWorth,false,true);netWorthDisplay.classList.toggle('negative',currentNetWorth<0);netWorthDisplay.classList.remove('positive')} if(cashDisplay) cashDisplay.textContent=formatCurrency(gameState.cash,false,true); if(totalLoanDisplay) totalLoanDisplay.textContent=formatCurrency(totalLoanBal,false,true); if(totalDebtServiceDisplay) totalDebtServiceDisplay.textContent=formatCurrency(totalYearlyDebtSvc,false,true); if(portfolioDscrDisplay){const v=portfolioDSCR;const d=isFinite(v)?formatDecimal(v,2):"N/A";portfolioDscrDisplay.textContent=d;const g=isFinite(v)&&v>=TARGET_DSCR;const o=isFinite(v)&&v>=1.0&&v<TARGET_DSCR;const b=!isFinite(v)||v<1.0;portfolioDscrDisplay.className=g?'positive':o?'ok':'negative'} if(avgRateDisplay) avgRateDisplay.textContent=formatPercentRate(currentAvgRate); if(totalNoiDisplay) totalNoiDisplay.textContent=formatCurrency(totalAnnualNOI,false,true); if(lastCashflowDisplay){const e=lastCashflowDisplay;e.textContent=formatCurrency(yearlyCashFlow,true,true);e.classList.toggle('positive',yearlyCashFlow>0);e.classList.toggle('negative',yearlyCashFlow<0)} if(levelIconEl&&levelTextEl&&goalProgressEl){const c=LEVEL_MILESTONES[gameState.playerLevel]||LEVEL_MILESTONES[0];const n=LEVEL_MILESTONES[gameState.playerLevel+1];levelIconEl.textContent=c.icon;levelTextEl.textContent=c.name;if(n){goalProgressEl.textContent=`Next: ${formatCurrency(n.threshold,false,true)} / Yr CF`}else{goalProgressEl.textContent="Legend Status!"}}} catch(e) { console.error("Header UI Error:", e); }

            // Update Portfolio (Same as v13.1)
             try { if(propertiesArea){propertiesArea.innerHTML='';if(gameState.properties&&gameState.properties.length>0){gameState.properties.forEach(p=>{if(!p||!p.loan){console.warn("Invalid prop UI:",p);return}const c=document.createElement('div');c.className='property-card card';const v=Number(p.value)||0;const n=Number(p.noi)||0;const a=n*12;const lB=Number(p.loan.balance)||0;const lR=Number(p.loan.rate)||0;const mR=Number(p.loan.monthsRemaining)||0;const m=Math.ceil(mR);const pM=(lB>0&&mR>0)?calculateMonthlyPayment(lB,lR,mR):0;const aD=(lB>0&&mR>0)?calculateAnnualDebtService(lB,lR,mR):0;let dS=Infinity;if(aD>0){dS=a>0?(a/aD):0}else if(a<=0&&aD<=0){dS=Infinity}const cR=v>0?(a/v):0;let vT='―',vC='trend-stable';if(valueHistory&&valueHistory.length>=2){const cV=valueHistory[valueHistory.length-1];const pV=valueHistory[valueHistory.length-2];if(cV>pV*1.0001){vT='▲';vC='trend-up'}else if(cV<pV*0.9999){vT='▼';vC='trend-down'}}let dC='';if(isFinite(dS)){if(dS>=TARGET_DSCR)dC='good';else if(dS>=1.0)dC='ok';else dC='bad'}else{dC='good'}c.innerHTML=`<div class="card-header"><h3>${p.name||'Unk'}</h3><span class="card-icon">${p.type||'❓'}</span></div><p><span class="label">Value:</span><span class="value-info"><span>${formatCurrency(v)}</span><span class="trend-indicator ${vC}">${vT}</span></span></p><p><span class="label">Cap:</span><span>${formatPercent(cR*100)}</span></p><p><span class="label">NOI/Yr:</span><span>${formatCurrency(a)}</span></p><p><span class="label">DSCR:</span><span class="dscr-value ${dC}">${isFinite(dS)?formatDecimal(dS,2):'N/A'}</span></p><p><span class="label">Loan:</span><span>${formatCurrency(lB)}</span></p><p><span class="label">Rate:</span><span>${formatPercentRate(lR)}</span></p><p><span class="label">Pmt/Mo:</span><span>${formatCurrency(pM)}</span></p><p><span class="label">Term:</span><span>${lB>0&&m>0?m+' mo':(lB<=0?'Paid':'N/A')}</span></p><div class="property-actions"><button class="btn-refi" data-prop-id="${p.id}" ${lB<=0||isPausedByError?'disabled':''}>Refi Quote</button><button class="btn-sell" data-prop-id="${p.id}" ${isPausedByError?'disabled':''}>Sell</button></div>`;propertiesArea.appendChild(c)})}else{propertiesArea.innerHTML='<p style="font-size:0.8rem;color:var(--text-secondary);text-align:center;grid-column:1 / -1;">No properties. Buy from Marketplace!</p>'}} } catch(e) { console.error("Portfolio UI Error:", e); }

            // Update Marketplace (Same as v13.1 - uses isPausedByError)
             try { if(marketplaceArea){marketplaceArea.innerHTML='';if(gameState.marketplaceProperties.length===0){marketplaceArea.innerHTML='<p style="font-size:0.8rem;color:var(--text-secondary);text-align:center;grid-column:1 / -1;">No properties listed...</p>'}else{gameState.marketplaceProperties.forEach(p=>{if(!p){console.warn("Invalid market prop:",p);return}const c=document.createElement('div');c.className='marketplace-card card';const aP=Number(p.price)||0;const mN=Number(p.noi)||0;const aN=mN*12;const cR=aP>0?(aN/aP):0;const pR=Math.max(MIN_RATE,gameState.marketRate+PURCHASE_RATE_PREMIUM);const dS=calculateMaxLoanByDSCR(aN,pR,PURCHASE_LOAN_TERM_MONTHS,TARGET_DSCR);const ltv=aP*MAX_LTV_PURCHASE;const lA=Math.max(0,Math.min(dS,ltv));const dP=aP-lA;const eC=lA*REFI_CLOSING_COST_PERCENT;const tN=dP+eC;const cA=gameState.cash>=tN;const f=gameState.properties.length>=MAX_PROPERTIES;c.innerHTML=`<div class="card-header"><h3>${p.name||'Unk'}</h3><span class="card-icon">${p.type||'❓'}</span></div><p><span class="label">Asking:</span><span>${formatCurrency(aP)}</span></p><p><span class="label">Cap:</span><span>${formatPercent(cR*100)}</span></p><p><span class="label">Est NOI/Yr:</span><span>${formatCurrency(aN)}</span></p><p><span class="label">Affordable:</span><span style="font-weight:600;color:${cA?'var(--accent-green)':'var(--accent-red)'};">${cA?'Yes':'No'}</span></p><button class="btn-buy" data-prop-id="${p.id}" ${!cA||f||isPausedByError?'disabled':''} title="${!cA?`Need ${formatCurrency(tN)}` :f?'Full':isPausedByError?'Paused':`Buy`}">${f?'Full':'Purchase'}</button>`;marketplaceArea.appendChild(c)})}}} catch(e) { console.error("Marketplace UI Error:", e); }

            // --- Update Refinance Offers --- (Adds cash-out-positive class)
             try {
                if(offersList && noOffersMessage) {
                    offersList.innerHTML = '';
                    const activeOffers = gameState.offers.filter(o => o.type === 'Refinance' || o.type === 'Refinance Quote');
                    if (activeOffers.length === 0) {
                        noOffersMessage.style.display = 'block'; offersList.style.display = 'block'; // Ensure container is block for message
                    } else {
                        noOffersMessage.style.display = 'none'; offersList.style.display = 'grid'; // Restore grid
                        activeOffers.forEach(offer => {
                             if (!offer) { console.warn("Invalid offer UI:", offer); return; }
                            const card = document.createElement('div');
                            const offerTypeClass = offer.type?.toLowerCase().replace(/ /g, '-') || 'unknown';
                            card.className = `offer-card card offer-type-${offerTypeClass}`; // Base card + offer styles
                            const monthlyNOI=Number(offer.monthlyNOI)||0;const newRate=Number(offer.newRate)||0;const currentRate=Number(offer.currentRate)||0;const newLoanAmount=Number(offer.newLoanAmount)||0;const cashOutAmount=Number(offer.cashOutAmount)||0;const newPotentialPayment=Number(offer.newPotentialPayment)||0;const newDSCR=Number(offer.newDSCR)||Infinity;const newTerm=Number(offer.newTerm)||0;const closingCosts=Number(offer.closingCosts)||0;
                            let dscrClass='';if(isFinite(newDSCR)){if(newDSCR>=TARGET_DSCR)dscrClass='good';else if(newDSCR>=1.0)dscrClass='ok';else dscrClass='bad'}else{dscrClass='good'}
                            const disableActions = isPausedByError; // Disable only if paused by error

                            // Add cash-out-positive class conditionally
                            const cashOutClass = cashOutAmount > 0 ? 'cash-out-positive' : '';

                            card.innerHTML = `
                                <div class="offer-card-header"><h3>${offer.propertyName||'N/A'}</h3><span class="offer-source">(${offer.source||'Unk'})</span></div>
                                <div class="offer-card-body">
                                    <span class="label">Monthly NOI:</span> <span>${formatCurrency(monthlyNOI)}</span>
                                    <span class="label">New Rate:</span> <span><strong>${formatPercentRate(newRate)}</strong> <span class="rate-info">(Old: ${formatPercentRate(currentRate)})</span></span>
                                    <span class="label">New Loan:</span> <span>${formatCurrency(newLoanAmount)}</span>
                                    <span class="label">Cash Out:</span> <span class="${cashOutClass}">${formatCurrency(cashOutAmount)}</span>
                                    <span class="label">New Pmt/Mo:</span> <span>${formatCurrency(newPotentialPayment)}</span>
                                    <span class="label">New DSCR:</span> <span class="dscr-value ${dscrClass}">${isFinite(newDSCR)?formatDecimal(newDSCR,2):'N/A'}</span>
                                    <span class="label">New Term:</span> <span>${newTerm} mo</span>
                                </div>
                                <div class="offer-card-footer">
                                    <div class="offer-costs"><span class="label">Closing Costs:</span><span class="cost-value">${formatCurrency(closingCosts)}</span></div>
                                    <div class="offer-actions">
                                        <button class="btn-accept" data-offer-id="${offer.offerId}" ${disableActions?'disabled':''}>Accept</button>
                                        <button class="btn-reject" data-offer-id="${offer.offerId}" ${disableActions?'disabled':''}>Reject</button>
                                    </div>
                                </div>`;
                            offersList.appendChild(card); }); } }
            } catch(e) { console.error("Offers UI Error:", e); }

             if (refreshMarketplaceBtn) { refreshMarketplaceBtn.disabled = isPausedByError; }
        } // --- End of updateUI ---


        // --- Event Listeners Setup --- (Unchanged)
         if (propertiesArea) { propertiesArea.addEventListener('click', (e) => { if (e.target.matches('.btn-refi')) { const id=Number(e.target.dataset.propId); if (!isNaN(id)) requestRefinance(id); } else if (e.target.matches('.btn-sell')) { const id=Number(e.target.dataset.propId); if (!isNaN(id)) sellProperty(id); } }); } else { console.error("Props area missing!"); }
         if (marketplaceArea) { marketplaceArea.addEventListener('click', (e) => { if (e.target.matches('.btn-buy')) { const id=Number(e.target.dataset.propId); if (!isNaN(id)) attemptPurchase(id); } }); } else { console.error("Market area missing!"); }
         if (offersList) { offersList.addEventListener('click', (e) => { if (e.target.matches('.btn-accept')) { handleAcceptOffer(e); } else if (e.target.matches('.btn-reject')) { handleRejectOffer(e); } }); } else { console.error("Offers list missing!"); }
         if (restartBtn) { restartBtn.addEventListener('click', initGame); } else { console.error("Restart button missing!"); }
         if(lowerRateOffersBtn) { lowerRateOffersBtn.addEventListener('click', (e) => { if (gameState) { gameState.receiveLowerRateOffers = !gameState.receiveLowerRateOffers; e.target.classList.toggle('active', gameState.receiveLowerRateOffers); logMessage(`Pref Update: Best Rate Alerts = ${gameState.receiveLowerRateOffers ? 'ON' : 'OFF'}`, "action"); } }); } else { console.error("Lower rate button missing!"); }
         if(cashOutOffersBtn) { cashOutOffersBtn.addEventListener('click', (e) => { if (gameState) { gameState.receiveCashOutOffers = !gameState.receiveCashOutOffers; e.target.classList.toggle('active', gameState.receiveCashOutOffers); logMessage(`Pref Update: Max Cash-Out Alerts = ${gameState.receiveCashOutOffers ? 'ON' : 'OFF'}`, "action"); } }); } else { console.error("Cash out button missing!"); }
         if(refreshMarketplaceBtn) { refreshMarketplaceBtn.addEventListener('click', refreshMarketplace); } else { console.error("Refresh Market button missing!"); }

        // --- Initial Game Start ---
        window.onload = function() { if (!document.getElementById('game-container') || !propertiesArea || !messageLog || !rateLine || !networthLine ) { console.error("Essential elements missing."); alert("Error: Critical components missing."); return; } console.log("DOM loaded, init game..."); setTimeout(initGame, 150); };

    </script>

</body>
</html>